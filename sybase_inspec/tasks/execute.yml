---
# Sybase InSpec execution tasks with SSH support
#
# EXECUTION MODES:
# Mode 1: Delegate/Bastion Mode (when inspec_delegate_host is defined)
#   - Layer 1: Ansible SSHs to delegate host using ansible_user (from inventory)
#   - Layer 2: Delegate host SSHs to Sybase server using sybase_ssh_user (for InSpec SSH transport)
#   - Layer 3: InSpec connects to database using sybase_username/sybase_password (from vault)
#
# Mode 2: Local/Direct Mode (when inspec_delegate_host is undefined or empty)
#   - Layer 1: InSpec runs directly on AAP2/local machine
#   - Layer 2: InSpec SSHs to Sybase server using sybase_ssh_user (for InSpec SSH transport)
#   - Layer 3: InSpec connects to database using sybase_username/sybase_password (from vault)
#
# Note: Sybase ALWAYS uses SSH transport for InSpec, regardless of execution mode

- name: Determine execution mode
  set_fact:
    use_delegate_host: "{{ inspec_delegate_host is defined and inspec_delegate_host | length > 0 and inspec_delegate_host != 'localhost' }}"

- name: Gather facts from delegate host (delegate mode only)
  setup:
  delegate_to: "{{ inspec_delegate_host }}"
  delegate_facts: true
  when: use_delegate_host | bool

- name: Build environment variables using delegate host facts (delegate mode)
  set_fact:
    sybase_environment:
      PATH: "{{ sybase_environment_base.PATH }}:{{ hostvars[inspec_delegate_host].ansible_env.PATH }}"
      LD_LIBRARY_PATH: "{{ sybase_environment_base.LD_LIBRARY_PATH }}:{{ hostvars[inspec_delegate_host].ansible_env.LD_LIBRARY_PATH | default('') }}"
      SYBASE: "{{ sybase_environment_base.SYBASE }}"
      SYBASE_OCS: "{{ sybase_environment_base.SYBASE_OCS }}"
      INSPEC_BACKEND: "{{ sybase_environment_base.INSPEC_BACKEND }}"
      SSH_AUTH_SOCK: "{{ hostvars[inspec_delegate_host].ansible_env.SSH_AUTH_SOCK | default('') }}"
  when: use_delegate_host | bool

- name: Build environment variables for local execution (local mode)
  set_fact:
    sybase_environment:
      PATH: "{{ sybase_environment_base.PATH }}:{{ ansible_env.PATH }}"
      LD_LIBRARY_PATH: "{{ sybase_environment_base.LD_LIBRARY_PATH }}:{{ ansible_env.LD_LIBRARY_PATH | default('') }}"
      SYBASE: "{{ sybase_environment_base.SYBASE }}"
      SYBASE_OCS: "{{ sybase_environment_base.SYBASE_OCS }}"
      INSPEC_BACKEND: "{{ sybase_environment_base.INSPEC_BACKEND }}"
      SSH_AUTH_SOCK: "{{ ansible_env.SSH_AUTH_SOCK | default('') }}"
  when: not (use_delegate_host | bool)

- name: Execute Sybase InSpec controls via SSH on delegate host (delegate mode with SSH)
  shell: |
    /usr/bin/inspec exec {{ item.path }} \
      --ssh://${INSPEC_SSH_USER}:${INSPEC_SSH_PASSWORD}@${INSPEC_DB_HOST} \
      -o {{ sybase_ssh_key_path }} \
      --input usernm="$INSPEC_DB_USERNAME" \
              passwd="$INSPEC_DB_PASSWORD" \
              hostnm="$INSPEC_DB_HOST" \
              servicenm="$INSPEC_DB_SERVICE" \
              port="$INSPEC_DB_PORT" \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ sybase_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ sybase_environment.LD_LIBRARY_PATH }}"
    SYBASE: "{{ sybase_environment.SYBASE }}"
    SYBASE_OCS: "{{ sybase_environment.SYBASE_OCS }}"
    INSPEC_BACKEND: "{{ sybase_environment.INSPEC_BACKEND }}"
    INSPEC_SSH_USER: "{{ sybase_ssh_user }}"
    INSPEC_SSH_PASSWORD: "{{ sybase_ssh_password }}"
    INSPEC_DB_USERNAME: "{{ sybase_username }}"
    INSPEC_DB_PASSWORD: "{{ sybase_password }}"
    INSPEC_DB_HOST: "{{ sybase_server }}"
    INSPEC_DB_SERVICE: "{{ sybase_service | default('') }}"
    INSPEC_DB_PORT: "{{ sybase_port }}"
  register: sybase_inspec_results
  loop: "{{ sybase_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: false
  no_log: true
  async: "{{ inspec_command_timeout | default(1800) }}"
  poll: 30
  when:
    - use_delegate_host | bool
    - sybase_use_ssh | default(true)
  delegate_to: "{{ inspec_delegate_host }}"

- name: Execute Sybase InSpec controls via SSH locally (local mode with SSH)
  shell: |
    /usr/bin/inspec exec {{ item.path }} \
      --ssh://${INSPEC_SSH_USER}:${INSPEC_SSH_PASSWORD}@${INSPEC_DB_HOST} \
      -o {{ sybase_ssh_key_path }} \
      --input usernm="$INSPEC_DB_USERNAME" \
              passwd="$INSPEC_DB_PASSWORD" \
              hostnm="$INSPEC_DB_HOST" \
              servicenm="$INSPEC_DB_SERVICE" \
              port="$INSPEC_DB_PORT" \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ sybase_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ sybase_environment.LD_LIBRARY_PATH }}"
    SYBASE: "{{ sybase_environment.SYBASE }}"
    SYBASE_OCS: "{{ sybase_environment.SYBASE_OCS }}"
    INSPEC_BACKEND: "{{ sybase_environment.INSPEC_BACKEND }}"
    INSPEC_SSH_USER: "{{ sybase_ssh_user }}"
    INSPEC_SSH_PASSWORD: "{{ sybase_ssh_password }}"
    INSPEC_DB_USERNAME: "{{ sybase_username }}"
    INSPEC_DB_PASSWORD: "{{ sybase_password }}"
    INSPEC_DB_HOST: "{{ sybase_server }}"
    INSPEC_DB_SERVICE: "{{ sybase_service | default('') }}"
    INSPEC_DB_PORT: "{{ sybase_port }}"
  register: sybase_inspec_results
  loop: "{{ sybase_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: false
  no_log: true
  async: "{{ inspec_command_timeout | default(1800) }}"
  poll: 30
  when:
    - not (use_delegate_host | bool)
    - sybase_use_ssh | default(true)

- name: Execute Sybase InSpec controls directly on delegate host (delegate mode without SSH)
  shell: |
    /usr/bin/inspec exec {{ item.path }} \
      --input usernm="$INSPEC_DB_USERNAME" \
              passwd="$INSPEC_DB_PASSWORD" \
              hostnm="$INSPEC_DB_HOST" \
              servicenm="$INSPEC_DB_SERVICE" \
              port="$INSPEC_DB_PORT" \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ sybase_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ sybase_environment.LD_LIBRARY_PATH }}"
    SYBASE: "{{ sybase_environment.SYBASE }}"
    SYBASE_OCS: "{{ sybase_environment.SYBASE_OCS }}"
    INSPEC_BACKEND: "{{ sybase_environment.INSPEC_BACKEND }}"
    INSPEC_DB_USERNAME: "{{ sybase_username }}"
    INSPEC_DB_PASSWORD: "{{ sybase_password }}"
    INSPEC_DB_HOST: "{{ sybase_server }}"
    INSPEC_DB_SERVICE: "{{ sybase_service | default('') }}"
    INSPEC_DB_PORT: "{{ sybase_port }}"
  register: sybase_inspec_results_direct
  loop: "{{ sybase_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: false
  no_log: true
  async: "{{ inspec_command_timeout | default(1800) }}"
  poll: 30
  when:
    - use_delegate_host | bool
    - not (sybase_use_ssh | default(true))
  delegate_to: "{{ inspec_delegate_host }}"

- name: Execute Sybase InSpec controls directly locally (local mode without SSH)
  shell: |
    /usr/bin/inspec exec {{ item.path }} \
      --input usernm="$INSPEC_DB_USERNAME" \
              passwd="$INSPEC_DB_PASSWORD" \
              hostnm="$INSPEC_DB_HOST" \
              servicenm="$INSPEC_DB_SERVICE" \
              port="$INSPEC_DB_PORT" \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ sybase_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ sybase_environment.LD_LIBRARY_PATH }}"
    SYBASE: "{{ sybase_environment.SYBASE }}"
    SYBASE_OCS: "{{ sybase_environment.SYBASE_OCS }}"
    INSPEC_BACKEND: "{{ sybase_environment.INSPEC_BACKEND }}"
    INSPEC_DB_USERNAME: "{{ sybase_username }}"
    INSPEC_DB_PASSWORD: "{{ sybase_password }}"
    INSPEC_DB_HOST: "{{ sybase_server }}"
    INSPEC_DB_SERVICE: "{{ sybase_service | default('') }}"
    INSPEC_DB_PORT: "{{ sybase_port }}"
  register: sybase_inspec_results_direct
  loop: "{{ sybase_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: false
  no_log: true
  async: "{{ inspec_command_timeout | default(1800) }}"
  poll: 30
  when:
    - not (use_delegate_host | bool)
    - not (sybase_use_ssh | default(true))

- name: Set results variable for processing
  set_fact:
    sybase_final_results: "{{ sybase_use_ssh | ternary(sybase_inspec_results, sybase_inspec_results_direct) }}"

- name: Display sanitized execution summary (debug mode only)
  debug:
    msg: |
      Sybase InSpec Execution Summary
      ===============================
      Database: {{ sybase_server }}:{{ sybase_port }}
      Service: {{ sybase_service | default('N/A') }}
      SSH Mode: {{ sybase_use_ssh | default(true) }}
      {% if sybase_use_ssh | default(true) %}
      SSH User: {{ sybase_ssh_user }}
      SSH Password: [PROTECTED - passed via environment variable]
      {% endif %}
      DB Username: {{ sybase_username }}
      DB Password: [PROTECTED - passed via environment variable]
      Control: {{ item.item.path | basename }}
      Status: {{ 'PASS' if item.rc == 0 else 'FAIL' }}
      Exit Code: {{ item.rc }}
  loop: "{{ sybase_final_results.results }}"
  loop_control:
    label: "{{ item.item.path | basename }}"
  when: inspec_debug_mode | default(false)

- name: Process Sybase InSpec results
  include_tasks: process_results.yml
  loop: "{{ sybase_final_results.results }}"
  loop_control:
    index_var: idx
    label: "Processing Sybase result {{ idx + 1 }}"
