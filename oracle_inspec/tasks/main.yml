---
# Main task file for Oracle InSpec role
# Following the same modular pattern as MSSQL role

- name: Oracle InSpec Compliance Scan Starting
  debug:
    msg: |
       Oracle InSpec Compliance Scan
      ================================
      Server: {{ oracle_server }}:{{ oracle_port }}
      Database: {{ oracle_database }}
      Service: {{ oracle_service }}
      Version: {{ oracle_version }}
      Username: {{ oracle_username }}

      Hello World from Oracle InSpec Role! ðŸŒ

- name: Validate Oracle connection parameters and environment
  include_tasks: validate.yml

- name: Copy control files to delegate host (when using remote delegate)
  block:
    - name: Create temporary directory for control files on delegate host
      tempfile:
        state: directory
        suffix: "_oracle_controls"
      register: delegate_controls_dir
      delegate_to: "{{ inspec_delegate_host }}"

    - name: Copy Oracle control files to delegate host
      copy:
        src: "{{ role_path }}/files/ORACLE{{ oracle_version }}_ruby/"
        dest: "{{ delegate_controls_dir.path }}/ORACLE{{ oracle_version }}_ruby/"
        mode: '0755'
      delegate_to: "{{ inspec_delegate_host }}"

    - name: Set control files location for delegate host
      set_fact:
        oracle_controls_base_dir: "{{ delegate_controls_dir.path }}"
  when:
    - inspec_delegate_host is defined
    - inspec_delegate_host | length > 0
    - inspec_delegate_host != 'localhost'

- name: Set control files location for local execution
  set_fact:
    oracle_controls_base_dir: "{{ role_path }}/files"
  when: >
    inspec_delegate_host is not defined or
    inspec_delegate_host | length == 0 or
    inspec_delegate_host == 'localhost'

- name: Setup directories and find Oracle control files
  include_tasks: setup.yml

- name: Execute Oracle InSpec controls and process results
  include_tasks: execute.yml

- name: Generate reports and cleanup
  include_tasks: cleanup.yml

- name: Oracle InSpec Compliance Scan Complete
  debug:
    msg: |
      [OK] Oracle InSpec scan completed successfully!
      Results directory: {{ inspec_results_dir }}
      Platform: ORACLE
      Database: {{ oracle_database }}
      Version: {{ oracle_version }}