name: Validate Commit Messages

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - master
      - develop

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for all branches

      - name: Validate commit messages
        run: |
          # Configuration - modify this regex as needed
          COMMIT_REGEX='^((build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\(\w+\))?(!)?(: (.*\s*)*))|(Merge (.*\s*)*)|(Initial commit$)'
          
          # For PRs, check all commits in the PR
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            commits=$(git rev-list ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            # For pushes, check the pushed commits
            commits=$(git rev-list ${{ github.event.before }}..${{ github.event.after }} 2>/dev/null || git rev-list HEAD~1..HEAD)
          fi
          
          failed=0
          invalid_commits=""
          
          for commit in $commits; do
            commit_msg=$(git log --format=%s -n 1 "$commit")
            
            if ! echo "$commit_msg" | grep -qE "$COMMIT_REGEX"; then
              failed=1
              short_hash=$(echo $commit | cut -c1-7)
              invalid_commits="${invalid_commits}\n  - ${short_hash}: ${commit_msg}"
            fi
          done
          
          if [ $failed -eq 1 ]; then
            echo "âŒ ERROR: Invalid commit message format detected!"
            echo ""
            echo "The following commits do not match the required format:"
            echo -e "$invalid_commits"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“ REQUIRED FORMATS:"
            echo ""
            echo "  Simple: <type>: JIRA-XXX <description>"
            echo "    Example: feat: JIRA-123 Add user authentication"
            echo ""
            echo "  Conventional: <type>(<scope>): <description>"
            echo "    Example: feat(auth): add OAuth2 integration"
            echo ""
            echo "  Valid types: build, chore, ci, docs, feat, fix,"
            echo "               perf, refactor, revert, style, test"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ’¡ Fix with: git rebase -i and reword commits"
            exit 1
          fi
          
          echo "âœ… All commit messages are valid!"