# Oracle Connection Types Enhancement - Handoff Document

**Date:** 2026-01-29
**Author:** DevOps Team
**Status:** Ready for Implementation
**Priority:** Critical (Banking Requirement)

---

## Executive Summary

The Oracle InSpec role currently supports two connection methods: Easy Connect and TNS Names. Enterprise banking environments require additional connection types, particularly **TCPS (SSL/TLS encrypted connections)** and **Oracle Wallet authentication**. This document outlines the enhancement plan.

---

## Current State

### Supported Connection Methods

| Method | Status | Variable |
|--------|--------|----------|
| Easy Connect | ✅ Implemented | Default |
| TNS Names | ✅ Implemented | `oracle_use_tns: true` |
| TCPS (SSL/TLS) | ❌ Not Implemented | - |
| Oracle Wallet | ❌ Not Implemented | - |

### Current Variables (`defaults/main.yml`)

```yaml
oracle_use_tns: false
oracle_tns_admin: ""
oracle_tns_alias: ""
```

---

## Proposed Enhancement

### New Connection Types

| Method | Port | Use Case |
|--------|------|----------|
| **TCPS** | 2484 | Encrypted connections (PCI-DSS, SOX compliance) |
| **Oracle Wallet** | Any | Certificate-based auth, no passwords in scripts |
| **Easy Connect Plus** | 1521 | Timeout/retry parameters (Oracle 19c+) |

### New Variables (Proposed)

```yaml
# Connection Type Selection
oracle_connection_type: "easy_connect"  # easy_connect | tns | tcps | wallet

# TCPS Configuration
oracle_tcps_enabled: false
oracle_tcps_port: 2484
oracle_ssl_server_cert_dn: ""

# Oracle Wallet Configuration
oracle_wallet_location: ""
oracle_wallet_auto_login: true

# Network Encryption
oracle_sqlnet_encryption: "required"
oracle_sqlnet_crypto_checksum: "required"
oracle_cipher_suites:
  - "SSL_RSA_WITH_AES_256_CBC_SHA256"
```

---

## Implementation Tasks

### Phase 1: Foundation (3 days)

| Task | Description | Files |
|------|-------------|-------|
| 1.1 | Add connection type variables | `defaults/main.yml` |
| 1.2 | Create sqlnet.ora template | `templates/sqlnet.ora.j2` |
| 1.3 | Create TCPS tnsnames.ora template | `templates/tnsnames_tcps.ora.j2` |
| 1.4 | Add variable validation | `tasks/validate.yml` |

### Phase 2: Core Implementation (5 days)

| Task | Description | Files |
|------|-------------|-------|
| 2.1 | Add connection type routing | `tasks/execute.yml` |
| 2.2 | Deploy Oracle Net configs | `tasks/setup.yml` |
| 2.3 | Add TCPS preflight checks | `tasks/preflight.yml` |
| 2.4 | Clean up generated configs | `tasks/cleanup.yml` |

### Phase 3: InSpec + Wallet (4 days)

| Task | Description | Files |
|------|-------------|-------|
| 3.1 | Update InSpec inputs | `files/ORACLE*_ruby/inspec.yml` |
| 3.2 | Update control connection logic | `files/ORACLE*_ruby/controls/trusted.rb` |
| 3.3 | Implement wallet authentication | `tasks/execute.yml` |
| 3.4 | Integration testing | `test_playbooks/` |

---

## New Templates

### sqlnet.ora.j2

```jinja2
# Auto-generated by Ansible oracle_inspec role
{% if oracle_wallet_location %}
WALLET_LOCATION =
  (SOURCE =
    (METHOD = FILE)
    (METHOD_DATA =
      (DIRECTORY = {{ oracle_wallet_location }})
    )
  )
SQLNET.WALLET_OVERRIDE = TRUE
{% endif %}

{% if oracle_tcps_enabled %}
SSL_CLIENT_AUTHENTICATION = FALSE
{% if oracle_ssl_server_cert_dn %}
SSL_SERVER_CERT_DN = "{{ oracle_ssl_server_cert_dn }}"
{% endif %}
SSL_CIPHER_SUITES = ({{ oracle_cipher_suites | join(', ') }})
{% endif %}

SQLNET.ENCRYPTION_CLIENT = {{ oracle_sqlnet_encryption | upper }}
SQLNET.CRYPTO_CHECKSUM_CLIENT = {{ oracle_sqlnet_crypto_checksum | upper }}
```

### tnsnames_tcps.ora.j2

```jinja2
{{ oracle_tns_alias | default(oracle_service) | upper }} =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCPS)(HOST = {{ oracle_server }})(PORT = {{ oracle_tcps_port | default(2484) }}))
    (CONNECT_DATA =
      (SERVICE_NAME = {{ oracle_service }})
    )
{% if oracle_ssl_server_cert_dn %}
    (SECURITY =
      (SSL_SERVER_CERT_DN = "{{ oracle_ssl_server_cert_dn }}")
    )
{% endif %}
  )
```

---

## Example Configurations

### Easy Connect (Current Default)

```yaml
oracle_prod_db:
  oracle_server: "oracledb.example.internal"
  oracle_port: 1521
  oracle_service: "ORCLPRD"
  oracle_version: "19"
  oracle_username: "nist_scan_user"
  oracle_password: "{{ vault_oracle_password }}"
```

### TCPS Encrypted Connection

```yaml
oracle_secure_db:
  oracle_server: "secure-oracle.bank.internal"
  oracle_port: 2484
  oracle_service: "ORCLSEC"
  oracle_version: "19"
  oracle_connection_type: "tcps"
  oracle_tcps_enabled: true
  oracle_ssl_server_cert_dn: "CN=secure-oracle,O=Bank,C=US"
  oracle_username: "nist_scan_user"
  oracle_password: "{{ vault_oracle_password }}"
```

### Oracle Wallet (No Password)

```yaml
oracle_wallet_db:
  oracle_server: "oracle.bank.internal"
  oracle_port: 1521
  oracle_service: "ORCLWLT"
  oracle_version: "19"
  oracle_connection_type: "wallet"
  oracle_wallet_location: "/opt/oracle/wallet"
  oracle_tns_alias: "ORCLWLT"
  # No username/password needed - wallet provides credentials
```

---

## New Error Codes

| Code | Description |
|------|-------------|
| `TCPS_PORT_UNREACHABLE` | Cannot connect to TCPS port (2484) |
| `SSL_HANDSHAKE_FAILED` | SSL/TLS handshake failed |
| `CERT_VALIDATION_FAILED` | Server certificate DN mismatch |
| `WALLET_NOT_FOUND` | Wallet directory does not exist |
| `WALLET_INVALID` | Wallet cannot be opened |

---

## Testing Requirements

### Azure Test Matrix

| Connection Type | Test Server | Expected Result |
|-----------------|-------------|-----------------|
| Easy Connect | Oracle XE container | ✅ Already working |
| TNS Names | Oracle XE container | To be tested |
| TCPS | Requires SSL-enabled Oracle | Future |
| Wallet | Requires wallet setup | Future |

### Preflight Test Cases

| Scenario | Expected Behavior |
|----------|-------------------|
| TCPS port open, valid cert | `preflight_passed: true` |
| TCPS port closed | `preflight_passed: false`, code: `TCPS_PORT_UNREACHABLE` |
| Invalid certificate DN | `preflight_passed: false`, code: `CERT_VALIDATION_FAILED` |
| Wallet not found | `preflight_passed: false`, code: `WALLET_NOT_FOUND` |

---

## Dependencies

### External Dependencies

- Oracle Instant Client with SSL support on delegate host
- Valid SSL certificates for TCPS connections
- Oracle Wallet utilities (`orapki`, `mkstore`) for wallet mode

### Internal Dependencies

- Existing Oracle role must continue to work (backward compatibility)
- TNS_ADMIN directory must be writable on delegate host

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing configurations | High | Default to `easy_connect`, extensive regression testing |
| SSL certificate management complexity | Medium | Document certificate requirements, provide examples |
| Wallet setup complexity | Medium | Document wallet creation, consider automation |
| Azure test environment lacks TCPS | Low | Test TCPS in on-prem environment |

---

## Success Criteria

1. All existing Easy Connect configurations continue to work unchanged
2. TCPS connections successfully encrypt traffic (verified with tcpdump/wireshark)
3. Wallet authentication works without passwords in connection strings
4. Clear error messages for all failure scenarios
5. Documentation updated with examples for each connection type

---

## References

- [Oracle Net Services documentation](https://docs.oracle.com/en/database/oracle/oracle-database/19/netag/)
- [InSpec oracledb_session resource](https://docs.chef.io/inspec/resources/oracledb_session/)
- [Oracle TCPS configuration guide](https://docs.oracle.com/en/database/oracle/oracle-database/19/dbseg/configuring-secure-sockets-layer-authentication.html)
- Database Connectivity Agent Research (2026-01-29)

---

## Handoff Checklist

- [x] Research completed (all Oracle connection methods documented)
- [x] Current implementation analyzed
- [x] New variables designed
- [x] Templates drafted
- [x] Implementation phases defined
- [x] Test cases identified
- [ ] JIRA tickets created
- [ ] Sprint planning completed
- [ ] Implementation started

---

*Document created for project handoff and sprint planning.*
