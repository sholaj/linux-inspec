---
# Setup tasks for PostgreSQL InSpec role
# Control files are copied ONCE per version to a fixed path, then reused

# Set fixed paths (deterministic, not temp)
- name: Set control paths
  ansible.builtin.set_fact:
    _local_controls_path: "{{ role_path }}/files/POSTGRES{{ postgres_version }}_ruby"
    _remote_controls_path: "/tmp/inspec_postgres_{{ postgres_version }}"

# Create results directory on execution host
- name: Create results directory
  ansible.builtin.file:
    path: "{{ inspec_results_dir }}"
    state: directory
    mode: "0755"
  delegate_to: "{{ _delegate_host }}"

# Check if controls already exist on delegate (skip copy if present)
- name: Check if controls already copied
  ansible.builtin.stat:
    path: "{{ _remote_controls_path }}/inspec.yml"
  register: _controls_exist
  delegate_to: "{{ _delegate_host }}"

# Only copy controls if not already present
- name: Copy controls to delegate (once per version)
  when: not _controls_exist.stat.exists
  block:
    - name: Find control files for PostgreSQL version
      ansible.builtin.find:
        paths: "{{ _local_controls_path }}"
        patterns: "*.rb"
        recurse: true
      register: _control_files_found
      delegate_to: localhost

    - name: Validate control files exist
      ansible.builtin.fail:
        msg: "No control files found in {{ _local_controls_path }}"
      when: _control_files_found.files | length == 0

    - name: Create controls directory on delegate
      ansible.builtin.file:
        path: "{{ _remote_controls_path }}/controls"
        state: directory
        mode: "0755"
      delegate_to: "{{ _delegate_host }}"

    - name: Copy inspec.yml profile metadata
      ansible.builtin.copy:
        src: "{{ _local_controls_path }}/inspec.yml"
        dest: "{{ _remote_controls_path }}/inspec.yml"
        mode: "0644"
      delegate_to: "{{ _delegate_host }}"

    - name: Copy control files to delegate
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ _remote_controls_path }}/controls/"
        mode: "0644"
      loop: "{{ _control_files_found.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
      delegate_to: "{{ _delegate_host }}"

    - name: Display setup info
      ansible.builtin.debug:
        msg: "Copied {{ _control_files_found.files | length }} control(s) to {{ _remote_controls_path }}"
      when: inspec_debug_mode | default(false) | bool

- name: Display reuse info
  ansible.builtin.debug:
    msg: "Reusing existing controls at {{ _remote_controls_path }}"
  when:
    - _controls_exist.stat.exists
    - inspec_debug_mode | default(false) | bool
