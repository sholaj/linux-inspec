---
# Setup tasks for MSSQL InSpec role

- name: Determine execution mode for setup
  set_fact:
    use_delegate_host: "{{ inspec_delegate_host is defined and inspec_delegate_host | length > 0 and inspec_delegate_host != 'localhost' }}"

- name: Setup InSpec environment on delegate host (delegate mode)
  block:
    - name: Create results directory
      file:
        path: "{{ inspec_results_dir }}"
        state: directory
        mode: "0755"

    - name: Create temporary working directory
      file:
        path: "{{ inspec_temp_dir }}"
        state: directory
        mode: "0755"

    - name: Find all Ruby control files for specified MSSQL version
      find:
        paths: "{{ mssql_controls_path }}/MSSQL{{ mssql_version }}_ruby"
        patterns: "*.rb"
      register: control_files

    - name: Display control files to be executed
      debug:
        msg: "Found {{ control_files.files | length }} control file(s) for MSSQL {{ mssql_version }}"
      when: inspec_debug_mode | default(false)

    - name: Fail if no MSSQL control files found
      fail:
        msg: "No MSSQL control files found in {{ mssql_controls_path }}/MSSQL{{ mssql_version }}_ruby"
      when: control_files.files | length == 0
  delegate_to: "{{ inspec_delegate_host }}"
  when: use_delegate_host | bool

- name: Setup InSpec environment locally (local mode)
  block:
    - name: Create results directory
      file:
        path: "{{ inspec_results_dir }}"
        state: directory
        mode: "0755"

    - name: Create temporary working directory
      file:
        path: "{{ inspec_temp_dir }}"
        state: directory
        mode: "0755"

    - name: Find all Ruby control files for specified MSSQL version
      find:
        paths: "{{ mssql_controls_path }}/MSSQL{{ mssql_version }}_ruby"
        patterns: "*.rb"
      register: control_files

    - name: Display control files to be executed
      debug:
        msg: "Found {{ control_files.files | length }} control file(s) for MSSQL {{ mssql_version }}"
      when: inspec_debug_mode | default(false)

    - name: Fail if no MSSQL control files found
      fail:
        msg: "No MSSQL control files found in {{ mssql_controls_path }}/MSSQL{{ mssql_version }}_ruby"
      when: control_files.files | length == 0
  delegate_to: localhost
  when: not (use_delegate_host | bool)
