---
# Setup tasks for MSSQL InSpec role
# Control files are always copied to the execution host (_delegate_host)

# Create results directory on execution host
- name: Create results directory
  file:
    path: "{{ inspec_results_dir }}"
    state: directory
    mode: "0755"
  delegate_to: "{{ _delegate_host }}"

# Find control files on Ansible controller
- name: Set local controls path
  set_fact:
    _local_controls_path: "{{ role_path }}/files/MSSQL{{ mssql_version }}_ruby"

- name: Find control files for MSSQL version
  find:
    paths: "{{ _local_controls_path }}"
    patterns: "*.rb"
  register: _control_files_found
  delegate_to: localhost

- name: Validate control files exist
  fail:
    msg: "No control files found in {{ _local_controls_path }}"
  when: _control_files_found.files | length == 0

- name: Display control files count
  debug:
    msg: "Found {{ _control_files_found.files | length }} control file(s) for MSSQL {{ mssql_version }}"
  when: inspec_debug_mode | default(false)

# Copy control files to execution host
- name: Create temp directory on execution host
  tempfile:
    state: directory
    prefix: inspec_controls_
  register: _remote_dir
  delegate_to: "{{ _delegate_host }}"

- name: Copy control files to execution host
  copy:
    src: "{{ item.path }}"
    dest: "{{ _remote_dir.path }}/"
    mode: "0644"
  loop: "{{ _control_files_found.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  delegate_to: "{{ _delegate_host }}"

- name: Build remote control files list
  set_fact:
    _remote_files_list: "{{ _remote_files_list | default([]) + [{'path': _remote_dir.path + '/' + (item.path | basename)}] }}"
  loop: "{{ _control_files_found.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Set control files with remote paths
  set_fact:
    control_files:
      files: "{{ _remote_files_list }}"
    _remote_controls_path: "{{ _remote_dir.path }}"
