---
# MSSQL InSpec Role - Main Task File
# ===================================
#
# EXECUTION MODES:
# 1. Localhost Mode: inspec_delegate_host is empty, undefined, or "localhost"
#    - InSpec runs on the Ansible control node
#    - Control files are used directly from role_path
#
# 2. Delegate Mode: inspec_delegate_host is set to a remote hostname
#    - InSpec runs on the remote delegate host
#    - Control files are copied to the delegate host
#    - Results are fetched back to the control node
#
# PRE-FLIGHT CHECKS:
# Before running InSpec, the role validates:
# 1. TCP port connectivity (configurable timeout)
# 2. Database authentication (configurable timeout)
# If either fails, the database is skipped and reported.

# Step 1: Determine execution mode (set once, use everywhere)
- name: Determine execution mode
  set_fact:
    # Use delegate if a remote host is specified (not empty, not 'localhost', not inventory_hostname)
    _use_delegate: "{{ (inspec_delegate_host | default('')) not in ['', 'localhost', inventory_hostname] }}"
    # Delegate host: remote host if specified, otherwise run on inventory host
    _delegate_host: "{{ inspec_delegate_host if (inspec_delegate_host | default('')) not in ['', 'localhost', inventory_hostname] else inventory_hostname }}"
    _timestamp: "{{ ansible_date_time.epoch }}"
  tags: always

- name: Display execution mode
  debug:
    msg: "Execution mode: {{ 'DELEGATE (' + _delegate_host + ')' if _use_delegate else 'LOCALHOST (target host)' }}"
  when: inspec_debug_mode | default(false) | bool
  tags: always

# Step 2: Validate parameters
- name: Validate MSSQL connection parameters
  include_tasks: validate.yml
  tags: always

# Step 3: Pre-flight connectivity checks
- name: Run pre-flight connectivity checks
  include_tasks: preflight.yml
  when: preflight_enabled | default(true)
  tags: [preflight, always]

# Step 3b: Skip preflight - set passed if disabled
- name: Skip preflight - assume passed
  set_fact:
    preflight_passed: true
    preflight_skip_reason: ""
    preflight_error_code: ""
    _db_scan_record:
      host: "{{ mssql_server }}"
      port: "{{ mssql_port }}"
      database: "{{ mssql_database }}"
      db_type: "mssql"
      version: "{{ mssql_version }}"
      preflight_passed: true
      skip_reason: ""
      error_code: ""
      timestamp: "{{ ansible_date_time.iso8601 }}"
      inventory_host: "{{ inventory_hostname }}"
  when: not (preflight_enabled | default(true))
  tags: always

# Step 4: Handle preflight failure
- name: Handle preflight failure
  block:
    - name: Display skip notification
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║  SKIPPING DATABASE - Pre-flight check failed                     ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║  Server:   {{ mssql_server }}:{{ mssql_port }}
          ║  Database: {{ mssql_database }}
          ║  Reason:   {{ preflight_skip_reason }}
          ║  Code:     {{ preflight_error_code }}
          ╚══════════════════════════════════════════════════════════════════╝

    - name: Fail if continue_on_failure is disabled
      fail:
        msg: "Pre-flight check failed for {{ mssql_server }}:{{ mssql_port }}/{{ mssql_database }}: {{ preflight_skip_reason }}"
      when: not (preflight_continue_on_failure | default(true))
  when: not preflight_passed
  tags: always

# Step 5: Setup - prepare directories and control files (only if preflight passed)
- name: Setup execution environment
  include_tasks: setup.yml
  when: preflight_passed
  tags: setup

# Step 6: Execute InSpec scans (only if preflight passed)
- name: Execute InSpec compliance scans
  include_tasks: execute.yml
  when: preflight_passed
  tags: execute

# Step 7: Cleanup and reporting (always runs - reports skipped databases too)
- name: Generate reports and cleanup
  include_tasks: cleanup.yml
  tags: cleanup
