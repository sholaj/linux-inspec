---
# Process and save InSpec results to files
# Loop variable: item (from execute.yml loop)
# Index variable: _result_idx

- name: Set result file name
  set_fact:
    _result_file: "MSSQL_{{ mssql_server }}_{{ mssql_database }}_{{ mssql_version }}_{{ _timestamp }}_{{ control_files.files[_result_idx].path | basename | regex_replace('\\.rb$', '') }}.json"

- name: Save successful result
  copy:
    content: "{{ item.stdout }}"
    dest: "{{ inspec_results_dir }}/{{ _result_file }}"
    mode: "0644"
  delegate_to: "{{ _delegate_host }}"
  when:
    - item.stdout is defined
    - item.stdout | trim != ''
    - item.rc in [0, 100, 101]

- name: Save error result
  copy:
    content: |
      {
        "controls": [{
          "id": "ERROR",
          "title": "InSpec execution failed",
          "status": "error",
          "hostname": "{{ mssql_server }}",
          "database": "{{ mssql_database }}",
          "port": "{{ mssql_port }}",
          "version": "{{ mssql_version }}",
          "error": "{{ item.stderr | default('Unknown error') | regex_replace('\"', '\\\"') }}"
        }]
      }
    dest: "{{ inspec_results_dir }}/{{ _result_file }}"
    mode: "0644"
  delegate_to: "{{ _delegate_host }}"
  when:
    - item.rc is defined
    - item.rc not in [0, 100, 101]
