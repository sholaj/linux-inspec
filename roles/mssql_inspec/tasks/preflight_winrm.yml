---
# Pre-flight connectivity checks for MSSQL InSpec role - WINRM MODE
# ==================================================================
# Validates WinRM/AD connectivity to SQL Server before running InSpec scans.
# Called from preflight.yml when use_winrm is true.
#
# WinRM mode uses Windows/AD authentication to connect directly to mssql_server.
# This allows a single AD account to scan multiple SQL Servers in the domain.
#
# Output facts:
#   - preflight_passed: true/false - whether to proceed with InSpec scan
#   - preflight_skip_reason: string - reason for skipping (if applicable)
#   - preflight_error_code: string - error classification code
#   - winrm_platform_detected: string - platform info from inspec detect

# Step 1: Verify train-winrm plugin is installed
# Note: Enterprise InSpec bundles train-winrm as a system plugin, so we must use
# 'inspec plugin list' instead of 'gem list' which only shows standalone gems
- name: "[WinRM Preflight] Verify train-winrm plugin installed"
  shell: inspec plugin list 2>/dev/null | grep -q train-winrm
  args:
    executable: /bin/bash
  register: _winrm_plugin_check
  changed_when: false
  failed_when: false
  delegate_to: "{{ _delegate_host }}"

- name: "[WinRM Preflight] Fail if train-winrm not installed"
  set_fact:
    preflight_passed: false
    preflight_skip_reason: "train-winrm plugin is not installed on {{ _delegate_host }}. Install with: inspec plugin install train-winrm"
    preflight_error_code: "WINRM_PLUGIN_MISSING"
  when: _winrm_plugin_check.rc != 0

# Step 2: Test WinRM connectivity to SQL Server (only if plugin is installed)
# Connects directly to mssql_server using AD credentials
# URL format: winrm://user@host (port 5985 is default)
- name: "[WinRM Preflight] Test WinRM/AD connectivity to SQL Server"
  shell: |
    export CHEF_LICENSE=accept
    inspec detect \
      -t winrm://{{ winrm_username }}@{{ mssql_server }} \
      --password '{{ winrm_password }}' \
      2>&1
  args:
    executable: /bin/bash
  register: _winrm_detect
  changed_when: false
  failed_when: false
  delegate_to: "{{ _delegate_host }}"
  no_log: "{{ not (inspec_debug_mode | default(false)) }}"
  timeout: 60
  when: _winrm_plugin_check.rc == 0

- name: "[WinRM Preflight] Parse WinRM detection result"
  vars:
    # Combine stdout and stderr for error detection (Ruby errors go to stdout)
    _detect_output: "{{ (_winrm_detect.stdout | default('')) + (_winrm_detect.stderr | default('')) }}"
  set_fact:
    _winrm_connection_valid: "{{ _winrm_detect.rc == 0 if _winrm_detect is defined and _winrm_detect.rc is defined else false }}"
    winrm_platform_detected: "{{ _winrm_detect.stdout | default('') }}"
    _winrm_error_msg: >-
      {%- if _winrm_detect is skipped -%}
      train-winrm plugin check failed - skipped WinRM test
      {%- elif _winrm_detect.rc | default(0) == 124 -%}
      WinRM connection timeout to {{ mssql_server }}
      {%- elif 'Connection refused' in _detect_output -%}
      WinRM connection refused on {{ mssql_server }}
      {%- elif 'WinRMAuthorizationError' in _detect_output or 'Authentication failed' in _detect_output or 'Access is denied' in _detect_output -%}
      AD authentication failed for user '{{ winrm_username }}' on {{ mssql_server }}. Ensure username includes domain (user@domain.com)
      {%- elif 'getaddrinfo' in _detect_output or 'Name or service not known' in _detect_output -%}
      Cannot resolve hostname '{{ mssql_server }}'
      {%- elif 'Connection timed out' in _detect_output -%}
      WinRM connection timed out to {{ mssql_server }}
      {%- elif _winrm_detect.rc | default(0) != 0 -%}
      WinRM connection failed to {{ mssql_server }} (exit code: {{ _winrm_detect.rc | default('unknown') }})
      {%- else -%}
      {%- endif -%}
  when: _winrm_plugin_check.rc == 0

- name: "[WinRM Preflight] Set WinRM error details"
  vars:
    _detect_output: "{{ (_winrm_detect.stdout | default('')) + (_winrm_detect.stderr | default('')) }}"
  set_fact:
    preflight_skip_reason: "{{ _winrm_error_msg }}"
    preflight_error_code: >-
      {%- if _winrm_detect.rc | default(0) == 124 -%}
      WINRM_TIMEOUT
      {%- elif 'Connection refused' in _detect_output -%}
      WINRM_CONNECTION_REFUSED
      {%- elif 'WinRMAuthorizationError' in _detect_output or 'Authentication failed' in _detect_output or 'Access is denied' in _detect_output -%}
      WINRM_AUTH_FAILED
      {%- elif 'getaddrinfo' in _detect_output or 'Name or service not known' in _detect_output -%}
      WINRM_HOST_UNREACHABLE
      {%- elif 'Connection timed out' in _detect_output -%}
      WINRM_CONNECTION_TIMEOUT
      {%- elif _winrm_detect.rc | default(0) != 0 -%}
      WINRM_CONNECTION_FAILED
      {%- else -%}
      {%- endif -%}
  when:
    - _winrm_plugin_check.rc == 0
    - not (_winrm_connection_valid | default(false))

# Step 3: Set final preflight result
- name: "[WinRM Preflight] Set final preflight status"
  set_fact:
    preflight_passed: "{{ _winrm_connection_valid | default(false) }}"
  when: _winrm_plugin_check.rc == 0

- name: "[WinRM Preflight] Display WinRM detection"
  debug:
    msg: |
      WinRM/AD Authentication Successful
      Target: {{ mssql_server }}
      Platform: {{ winrm_platform_detected }}
  when:
    - preflight_passed | default(false)
    - inspec_debug_mode | default(false) | bool
