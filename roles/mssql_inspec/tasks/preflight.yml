---
# Pre-flight connectivity checks for MSSQL InSpec role
# =====================================================
# Validates database connectivity before running InSpec scans.
# Supports both direct (sqlcmd) and WinRM modes.
#
# Output facts:
#   - preflight_passed: true/false - whether to proceed with InSpec scan
#   - preflight_skip_reason: string - reason for skipping (if applicable)
#   - preflight_error_code: string - error classification code

- name: "[Preflight] Initialize preflight results"
  set_fact:
    preflight_passed: false
    preflight_skip_reason: ""
    preflight_error_code: ""
    _preflight_port_open: false
    _preflight_auth_valid: false

# Determine connection mode
- name: "[Preflight] Determine connection mode"
  set_fact:
    _connection_mode: "{{ 'winrm' if (use_winrm | default(false) | bool) else 'direct' }}"

- name: "[Preflight] Display connection mode"
  debug:
    msg: "Connection mode: {{ _connection_mode | upper }}"
  when: inspec_debug_mode | default(false) | bool

# Route to appropriate preflight based on mode
- name: "[Preflight] Run WinRM preflight checks"
  include_tasks: preflight_winrm.yml
  when: _connection_mode == 'winrm'

- name: "[Preflight] Run direct connection preflight checks"
  include_tasks: preflight_direct.yml
  when: _connection_mode == 'direct'

# Common post-preflight logging
- name: "[Preflight] Log preflight success"
  debug:
    msg: |
      Preflight PASSED - {{ mssql_server }}:{{ mssql_port }}/{{ mssql_database }}
      Mode: {{ _connection_mode | upper }}
      {% if _connection_mode == 'winrm' %}AD User: {{ winrm_username }}{% endif %}
  when:
    - preflight_passed
    - inspec_debug_mode | default(false) | bool

- name: "[Preflight] Log preflight failure"
  debug:
    msg: |
      Preflight FAILED - {{ mssql_server }}:{{ mssql_port }}/{{ mssql_database }}
      Mode: {{ _connection_mode | upper }}
      {% if _connection_mode == 'winrm' %}AD User: {{ winrm_username }}{% endif %}
      Reason: {{ preflight_skip_reason }}
      Error Code: {{ preflight_error_code }}
  when:
    - not preflight_passed
    - inspec_debug_mode | default(false) | bool

# Register this database in the scan results tracker
- name: "[Preflight] Register database scan attempt"
  set_fact:
    _db_scan_record:
      host: "{{ mssql_server }}"
      port: "{{ mssql_port }}"
      database: "{{ mssql_database }}"
      db_type: "mssql"
      version: "{{ mssql_version }}"
      connection_mode: "{{ _connection_mode }}"
      ad_user: "{{ winrm_username | default('N/A') if _connection_mode == 'winrm' else 'N/A' }}"
      preflight_passed: "{{ preflight_passed }}"
      skip_reason: "{{ preflight_skip_reason }}"
      error_code: "{{ preflight_error_code }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      inventory_host: "{{ inventory_hostname }}"
