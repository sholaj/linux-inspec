---
# InSpec execution tasks for MSSQL
# _delegate_host is always set: to inspec_delegate_host or inventory_hostname

# Build PATH with MSSQL tools directories
- name: Build execution environment
  set_fact:
    _mssql_env:
      PATH: "{{ mssql_tools_paths | join(':') }}:/usr/local/bin:/usr/bin:/bin"
      CHEF_LICENSE: "accept"

# Verify sqlcmd is available
- name: Verify sqlcmd binary
  shell: |
    export PATH="{{ _mssql_env.PATH }}"
    command -v sqlcmd
  args:
    executable: /bin/bash
  register: _sqlcmd_check
  changed_when: false
  failed_when: _sqlcmd_check.rc != 0
  delegate_to: "{{ _delegate_host }}"

- name: Set sqlcmd path
  set_fact:
    _sqlcmd_bin: "{{ _sqlcmd_check.stdout | trim }}"

# Test database connectivity
- name: Test database connectivity
  shell: |
    export PATH="{{ _mssql_env.PATH }}"
    timeout 10 "{{ _sqlcmd_bin }}" \
      -S '{{ mssql_server }},{{ mssql_port }}' \
      -U '{{ mssql_username }}' \
      -P '{{ mssql_password }}' \
      -Q "SELECT 1 AS test" -h -1
  args:
    executable: /bin/bash
  register: _db_test
  changed_when: false
  failed_when: false
  no_log: true
  delegate_to: "{{ _delegate_host }}"

- name: Fail if database unreachable
  fail:
    msg: |
      Cannot connect to {{ mssql_server }}:{{ mssql_port }}
      Exit code: {{ _db_test.rc }}
      Possible causes: wrong credentials, network issues, or database not running
  when: _db_test.rc != 0

# Verify InSpec is available
- name: Verify InSpec binary
  shell: |
    export PATH="{{ _mssql_env.PATH }}"
    command -v inspec
  args:
    executable: /bin/bash
  register: _inspec_check
  changed_when: false
  failed_when: _inspec_check.rc != 0
  delegate_to: "{{ _delegate_host }}"

- name: Set InSpec path
  set_fact:
    _inspec_bin: "{{ _inspec_check.stdout | trim }}"

# Execute InSpec controls
- name: Execute InSpec controls
  shell: |
    export PATH="{{ _mssql_env.PATH }}"
    export CHEF_LICENSE=accept

    "{{ _inspec_bin }}" exec "{{ item.path }}" \
      --input usernm='{{ mssql_username }}' \
              passwd='{{ mssql_password }}' \
              hostnm='{{ mssql_server }}' \
              servicenm='{{ mssql_service | default("") }}' \
              port='{{ mssql_port }}' \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  register: inspec_results
  loop: "{{ control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: inspec_results.rc not in [0, 100, 101]
  no_log: true
  delegate_to: "{{ _delegate_host }}"

# Parse and display results
- name: Parse InSpec results
  set_fact:
    _parsed_results: "{{ _parsed_results | default([]) + [item.stdout | from_json] }}"
  loop: "{{ inspec_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item.path | basename }}"
  when: item.stdout is defined and item.stdout != ''
  no_log: true

- name: Display scan summary
  debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
       MSSQL InSpec Compliance Scan Results
       Database: {{ mssql_server }}:{{ mssql_port }}/{{ mssql_database }}
      ═══════════════════════════════════════════════════════════════════
      {% set ns = namespace(passed=0, failed=0, total=0) %}
      {% for result in _parsed_results | default([]) %}
      {% for control in result.controls | default([]) %}
      {% set res = control.results | default([]) %}
      {% set status = res[0].status | default(control.status | default('unknown')) %}
      {% set ns.total = ns.total + 1 %}
      {% if status == 'passed' %}{% set ns.passed = ns.passed + 1 %}{% elif status == 'failed' %}{% set ns.failed = ns.failed + 1 %}{% endif %}
      {{ control.id }}: {{ status | upper }} - {{ control.title | default('N/A') | truncate(60) }}
      {% endfor %}
      {% endfor %}
      ───────────────────────────────────────────────────────────────────
       Total: {{ ns.total }} | Passed: {{ ns.passed }} | Failed: {{ ns.failed }}
      ═══════════════════════════════════════════════════════════════════
  when: _parsed_results is defined and (_parsed_results | length) > 0

# Process results for file output
- name: Process InSpec results
  include_tasks: process_results.yml
  loop: "{{ inspec_results.results | default([]) }}"
  loop_control:
    index_var: _result_idx
    label: "Result {{ _result_idx + 1 }}"
  when: inspec_results.results is defined
