---
# InSpec execution tasks for MSSQL
# =================================
# Routes to appropriate execution mode based on use_winrm variable.
# Supports both direct (sqlcmd) and WinRM modes.
#
# Prerequisites:
#   - _delegate_host is set (to inspec_delegate_host or inventory_hostname)
#   - preflight_passed is true
#   - _remote_controls_path is set (control files copied to delegate)

# Determine connection mode
- name: "[Execute] Determine connection mode"
  set_fact:
    _connection_mode: "{{ 'winrm' if (use_winrm | default(false) | bool) else 'direct' }}"

- name: "[Execute] Display execution mode"
  debug:
    msg: |
      Execution Mode: {{ _connection_mode | upper }}
      Delegate Host: {{ _delegate_host }}
      MSSQL Target: {{ mssql_server }}:{{ mssql_port }}/{{ mssql_database }}
      {% if _connection_mode == 'winrm' %}WinRM Target: {{ winrm_host }}:{{ winrm_port }}{% endif %}
  when: inspec_debug_mode | default(false) | bool

# Route to appropriate execution based on mode
- name: "[Execute] Run WinRM-based execution"
  include_tasks: execute_winrm.yml
  when: _connection_mode == 'winrm'

- name: "[Execute] Run direct execution"
  include_tasks: execute_direct.yml
  when: _connection_mode == 'direct'

# Common post-execution tasks
# Parse and display results
# Note: stdout may already be parsed as dict by Jinja2, or may be a string
- name: "[Execute] Parse InSpec results"
  set_fact:
    _parsed_results: "{{ _parsed_results | default([]) + [item.stdout if item.stdout is mapping else (item.stdout | from_json)] }}"
  loop: "{{ inspec_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item.path | basename }}"
  when: item.stdout is defined and item.stdout != ''
  no_log: true

- name: "[Execute] Display scan summary"
  debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
       MSSQL InSpec Compliance Scan Results
       Database: {{ mssql_server }}:{{ mssql_port }}/{{ mssql_database }}
       Mode: {{ _connection_mode | upper }}
       {% if _connection_mode == 'winrm' %}WinRM Target: {{ winrm_host }}:{{ winrm_port }}{% endif %}
      ═══════════════════════════════════════════════════════════════════
      {% set ns = namespace(passed=0, failed=0, total=0) %}
      {% for result in _parsed_results | default([]) %}
      {% for control in result.controls | default([]) %}
      {% set res = control.results | default([]) %}
      {% set status = res[0].status | default(control.status | default('unknown')) %}
      {% set ns.total = ns.total + 1 %}
      {% if status == 'passed' %}{% set ns.passed = ns.passed + 1 %}{% elif status == 'failed' %}{% set ns.failed = ns.failed + 1 %}{% endif %}
      {{ control.id }}: {{ status | upper }} - {{ control.title | default('N/A') | truncate(60) }}
      {% endfor %}
      {% endfor %}
      ───────────────────────────────────────────────────────────────────
       Total: {{ ns.total }} | Passed: {{ ns.passed }} | Failed: {{ ns.failed }}
      ═══════════════════════════════════════════════════════════════════
  when: _parsed_results is defined and (_parsed_results | length) > 0

# Process results for file output
- name: "[Execute] Process InSpec results"
  include_tasks: process_results.yml
  loop: "{{ inspec_results.results | default([]) }}"
  loop_control:
    index_var: _result_idx
    label: "Result {{ _result_idx + 1 }}"
  when: inspec_results.results is defined
