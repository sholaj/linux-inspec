---
# InSpec execution tasks for MSSQL
#
# EXECUTION MODES:
# Mode 1: Delegate/Bastion Mode (when inspec_delegate_host is defined)
#   - Ansible SSHs to delegate host using ansible_user (from inventory)
#   - InSpec runs on delegate host
#   - InSpec connects to database using mssql_username/mssql_password (from vault)
#
# Mode 2: Local/Direct Mode (when inspec_delegate_host is undefined or empty)
#   - InSpec runs directly on AAP2 execution node or local machine
#   - InSpec connects to database using mssql_username/mssql_password (from vault)
#
# These are DIFFERENT execution paths based on infrastructure setup

- name: Determine execution mode and target host
  set_fact:
    use_delegate_host: "{{ (inspec_delegate_host | default('')) not in ['', 'localhost'] }}"
    inspec_execution_target: "{{ inspec_delegate_host if (inspec_delegate_host | default('')) not in ['', 'localhost'] else 'localhost' }}"
    cacheable: yes

- name: Gather environment facts from execution target
  setup:
    gather_subset:
      - env
  delegate_to: "{{ inspec_execution_target }}"
  delegate_facts: true

- name: Set target environment from execution host
  set_fact:
    _target_env: "{{ hostvars[inspec_execution_target].ansible_env | default({'PATH': '', 'LD_LIBRARY_PATH': ''}) }}"

- name: Get system PATH from delegate host if not available in facts
  shell: echo "$PATH"
  register: delegate_system_path
  changed_when: false
  delegate_to: "{{ inspec_execution_target }}"
  when: not _target_env.PATH or _target_env.PATH == ''

- name: Update target environment with system PATH
  set_fact:
    _target_env: "{{ _target_env | combine({'PATH': delegate_system_path.stdout}) }}"
  when: delegate_system_path.stdout is defined

- name: Build environment variables
  set_fact:
    mssql_environment:
      PATH: "{{ mssql_environment_base.PATH }}{% if _target_env.PATH %}:{{ _target_env.PATH }}{% endif %}"
      LD_LIBRARY_PATH: "{{ mssql_environment_base.LD_LIBRARY_PATH }}{% if _target_env.LD_LIBRARY_PATH %}:{{ _target_env.LD_LIBRARY_PATH }}{% endif %}"

- name: Detect and validate sqlcmd binary
  block:
    - name: Detect sqlcmd binary location
      shell: |
        export PATH="{{ mssql_environment.PATH }}"
        set -euo pipefail
        
        # 1) Check PATH first
        if command -v sqlcmd >/dev/null 2>&1; then
          command -v sqlcmd
          exit 0
        fi
        
        # 2) Check common install locations
        for dir in /opt/mssql-tools18/bin /opt/mssql-tools/bin /usr/local/bin /usr/bin; do
          if [ -x "$dir/sqlcmd" ]; then
            echo "$dir/sqlcmd"
            exit 0
          fi
        done
        
        # 3) Last resort: search (limited depth for speed)
        find /opt /usr -maxdepth 5 -type f -name sqlcmd -perm -111 2>/dev/null | head -n 1 || exit 1
      args:
        executable: /bin/bash
      register: sqlcmd_detect
      changed_when: false
      failed_when: false
      delegate_to: "{{ inspec_execution_target }}"

    - name: Set sqlcmd_bin fact
      set_fact:
        sqlcmd_bin: "{{ (sqlcmd_detect.stdout | trim) if (sqlcmd_detect.rc == 0 and (sqlcmd_detect.stdout | trim) != '') else '' }}"

    - name: Fail if sqlcmd not found
      fail:
        msg: |
          CRITICAL: sqlcmd not found on {{ inspec_execution_target }}
          
          Detection output: {{ sqlcmd_detect.stdout | default('EMPTY') }}
          Exit code: {{ sqlcmd_detect.rc | default('UNDEFINED') }}
          Search PATH: {{ mssql_environment.PATH }}
          
          Install mssql-tools package or ensure sqlcmd is in PATH.
      when: sqlcmd_bin == ""

    - name: Update PATH with sqlcmd directory
      set_fact:
        mssql_environment:
          PATH: "{{ sqlcmd_bin | dirname }}:{{ mssql_environment.PATH }}"
          LD_LIBRARY_PATH: "{{ mssql_environment.LD_LIBRARY_PATH }}"
      when: "'/' in sqlcmd_bin"

    - name: Detect inspec binary location
      shell: |
        export PATH="{{ mssql_environment.PATH }}"
        command -v inspec || which inspec || echo "/usr/bin/inspec"
      args:
        executable: /bin/bash
      register: inspec_detect
      changed_when: false
      delegate_to: "{{ inspec_execution_target }}"

    - name: Set inspec_bin fact
      set_fact:
        inspec_bin: "{{ (inspec_detect.stdout | trim) if (inspec_detect.stdout | trim) != '' else 'inspec' }}"

- name: Test database connectivity with sqlcmd
  shell: |
    export PATH="{{ mssql_environment.PATH }}"
    set -euo pipefail
    
    timeout 10 "{{ sqlcmd_bin }}" \
      -S '{{ mssql_server }},{{ mssql_port }}' \
      -U '{{ mssql_username }}' \
      -P '{{ mssql_password }}' \
      -Q "SELECT @@VERSION" 2>&1
    
    echo "SUCCESS: Database connection verified"
  register: sqlcmd_test
  changed_when: false
  failed_when: false
  delegate_to: "{{ inspec_execution_target }}"
  no_log: true

- name: Fail if database is not reachable
  fail:
    msg: |
      CRITICAL: Cannot connect to database {{ mssql_server }}:{{ mssql_port }}
      
      Exit Code: {{ sqlcmd_test.rc | default('undefined') }}
      
      Diagnostics:
      {{ sqlcmd_test.stdout | default('') }}
      
      This could be due to:
      - sqlcmd not in PATH (exit code 127)
      - Connection timeout (exit code 124)
      - Incorrect credentials
      - Network connectivity issues
      - Database server not running
      - Firewall blocking connection
      
      Current PATH: {{ mssql_environment.PATH }}
  when: 
    - sqlcmd_test.rc is defined
    - sqlcmd_test.rc != 0

- name: Execute InSpec controls
  shell: |
    export PATH="{{ mssql_environment.PATH }}"
    export LD_LIBRARY_PATH="{{ mssql_environment.LD_LIBRARY_PATH }}"
    
    "{{ inspec_bin }}" exec {{ item.path }} \
      --input usernm='{{ mssql_username }}' \
              passwd='{{ mssql_password }}' \
              hostnm='{{ mssql_server }}' \
              servicenm='{{ mssql_service | default("") }}' \
              port='{{ mssql_port }}' \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  register: inspec_results
  loop: "{{ control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: false
  no_log: true
  delegate_to: "{{ inspec_execution_target }}"

- name: Initialize parsed results
  set_fact:
    parsed_results: []

- name: Parse InSpec results for display
  set_fact:
    parsed_results: "{{ parsed_results | default([]) + [item.stdout | from_json] }}"
  loop: "{{ inspec_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item.path | basename }}"
  when: 
    - item.stdout is defined 
    - item.stdout != ''
  no_log: true

- name: Display InSpec execution summary
  debug:
    msg: |
      
      ╔════════════════════════════════════════════════════════════════════════════════════════
      ║ InSpec Compliance Scan Results
      ║ Database: {{ mssql_server }}:{{ mssql_port }}
      ║ Scan User: {{ mssql_username }}
      ╚════════════════════════════════════════════════════════════════════════════════════════
      {% for result in parsed_results %}
      {% set controls = result.controls | default([]) %}
      {% for control in controls %}
      
      Control: {{ control.id }}
      Title  : {{ control.title | default('N/A') }}
      Status : {{ control.results[0].status | upper if control.results | length > 0 else 'UNKNOWN' }}
      {% if control.results | length > 0 and control.results[0].status != 'passed' %}
      Message: {{ control.results[0].message | default('No message') | regex_replace('\n', ' ') | truncate(120) }}
      {% endif %}
      ────────────────────────────────────────────────────────────────────────────────────────
      {% endfor %}
      {% endfor %}
      
      Summary:
      --------
      Total Controls: {{ parsed_results | map(attribute='controls') | flatten | length }}
      Passed        : {{ parsed_results | map(attribute='controls') | flatten | selectattr('results', 'defined') | selectattr('results', '>', []) | map(attribute='results') | flatten | selectattr('status', 'equalto', 'passed') | list | length }}
      Failed        : {{ parsed_results | map(attribute='controls') | flatten | selectattr('results', 'defined') | selectattr('results', '>', []) | map(attribute='results') | flatten | selectattr('status', 'equalto', 'failed') | list | length }}
      
  when: parsed_results is defined and parsed_results | length > 0

- name: Process InSpec results
  include_tasks: process_results.yml
  loop: "{{ inspec_results.results | default([]) }}"
  loop_control:
    index_var: idx
    label: "Processing result {{ idx + 1 }}"
  when: inspec_results.results is defined
