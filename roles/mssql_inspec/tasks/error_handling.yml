---
# Error aggregation and reporting for MSSQL InSpec scans
# ======================================================
# DBSCAN-710: Enhanced error handling for unreachable hosts
#
# Features:
# - Collects all scan errors across batch execution
# - Generates consolidated failed hosts report
# - Exports failed hosts as JSON for downstream processing
# - Provides remediation suggestions per error type
# - Sets failed_hosts fact for pipeline integration
#
# This task should be included in cleanup.yml or called from the playbook
# after all hosts have been processed.

# Initialize error tracking (run once per playbook execution)
- name: "[Error] Initialize error tracking"
  ansible.builtin.set_fact:
    _scan_errors: "{{ _scan_errors | default([]) }}"
    _failed_hosts: "{{ _failed_hosts | default([]) }}"
  run_once: true
  delegate_to: localhost

# Record scan failure if preflight failed
- name: "[Error] Record scan failure"
  ansible.builtin.set_fact:
    _scan_errors: "{{ _scan_errors + [_error_record] }}"
    _failed_hosts: "{{ _failed_hosts + [_failed_host_record] }}"
  vars:
    _error_record:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      host: "{{ inventory_hostname }}"
      mssql_server: "{{ mssql_server }}"
      mssql_port: "{{ mssql_port }}"
      mssql_database: "{{ mssql_database }}"
      mssql_version: "{{ mssql_version }}"
      connection_mode: "{{ _connection_mode | default('direct') }}"
      error_code: "{{ preflight_error_code | default('UNKNOWN') }}"
      error_message: "{{ preflight_skip_reason | default('Unknown error') }}"
      ad_user: "{{ winrm_username | default('N/A') if (_connection_mode | default('direct')) == 'winrm' else 'N/A' }}"
      remediation: "{{ _remediation_hint }}"
    _failed_host_record:
      inventory_host: "{{ inventory_hostname }}"
      server: "{{ mssql_server }}"
      port: "{{ mssql_port }}"
      error_code: "{{ preflight_error_code | default('UNKNOWN') }}"
    _remediation_hint: >-
      {%- if preflight_error_code == 'PORT_UNREACHABLE' -%}
      Check firewall rules and verify SQL Server is running on port {{ mssql_port }}
      {%- elif preflight_error_code == 'AUTH_FAILED' -%}
      Verify credentials (mssql_username/mssql_password) and SQL Server authentication mode
      {%- elif preflight_error_code == 'WINRM_AUTH_FAILED' -%}
      Verify AD credentials and GPO permissions for WinRM access
      {%- elif preflight_error_code == 'WINRM_CONNECTION_FAILED' -%}
      Check WinRM service status and firewall rules (port 5985)
      {%- elif preflight_error_code == 'DATABASE_NOT_FOUND' -%}
      Verify database '{{ mssql_database }}' exists and user has access
      {%- elif preflight_error_code == 'SQLCMD_NOT_FOUND' -%}
      Install MSSQL Tools on delegate host: yum install mssql-tools18
      {%- elif preflight_error_code == 'AUTH_TIMEOUT' -%}
      Increase preflight_auth_timeout or check network latency
      {%- else -%}
      Review error details and check connectivity to {{ mssql_server }}
      {%- endif -%}
  when: not (preflight_passed | default(false) | bool)
  delegate_to: localhost
  delegate_facts: true

# Generate error summary report (run once at end of batch)
- name: "[Error] Generate error summary report"
  ansible.builtin.template:
    src: error_summary.j2
    dest: "{{ inspec_results_dir }}/error_summary_{{ ansible_date_time.epoch }}.txt"
  delegate_to: localhost
  run_once: true
  when: (_scan_errors | default([]) | length) > 0

# Export failed hosts as JSON for downstream processing
- name: "[Error] Export failed hosts JSON"
  ansible.builtin.copy:
    content: |
      {
        "scan_timestamp": "{{ ansible_date_time.iso8601 }}",
        "total_failed": {{ _failed_hosts | default([]) | length }},
        "failed_hosts": {{ _failed_hosts | default([]) | to_nice_json }},
        "error_summary": {
          {% set error_counts = {} %}
          {% for error in _scan_errors | default([]) %}
          {% if error.error_code in error_counts %}
          {% set _ = error_counts.update({error.error_code: error_counts[error.error_code] + 1}) %}
          {% else %}
          {% set _ = error_counts.update({error.error_code: 1}) %}
          {% endif %}
          {% endfor %}
          {% for code, count in error_counts.items() %}
          "{{ code }}": {{ count }}{{ "," if not loop.last else "" }}
          {% endfor %}
        },
        "errors": {{ _scan_errors | default([]) | to_nice_json }}
      }
    dest: "{{ inspec_results_dir }}/{{ failed_hosts_report_file | default('failed_hosts_summary.json') }}"
    mode: "0644"
  delegate_to: "{{ _delegate_host | default('localhost') }}"
  run_once: true
  when:
    - (_scan_errors | default([]) | length) > 0
    - export_failed_hosts_json | default(true) | bool

# Set failed_hosts fact for downstream pipeline integration
- name: "[Error] Set failed_hosts fact for pipeline integration"
  ansible.builtin.set_fact:
    failed_hosts_list: "{{ _failed_hosts | default([]) }}"
    failed_hosts_count: "{{ _failed_hosts | default([]) | length }}"
    scan_errors: "{{ _scan_errors | default([]) }}"
  delegate_to: localhost
  delegate_facts: true
  run_once: true

# Display error summary with remediation hints
- name: "[Error] Display error summary with remediation"
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════════════
       MSSQL SCAN ERROR SUMMARY
      ═══════════════════════════════════════════════════════════════════════════
       Total Failed Hosts: {{ _scan_errors | default([]) | length }}
       Scan Timestamp: {{ ansible_date_time.iso8601 }}
      ───────────────────────────────────────────────────────────────────────────
       FAILED HOSTS:
      {% for error in _scan_errors | default([]) %}
       ┌─ {{ error.mssql_server }}:{{ error.mssql_port }}/{{ error.mssql_database }}
       │  Inventory Host: {{ error.host }}
       │  Error Code: {{ error.error_code }}
       │  Message: {{ error.error_message }}
       │  Mode: {{ error.connection_mode | upper }}{% if error.connection_mode == 'winrm' %} (AD User: {{ error.ad_user }}){% endif %}

       │  ⚠ Remediation: {{ error.remediation }}
       └──────────────────────────────────────────────────────────────────────────
      {% endfor %}
      ───────────────────────────────────────────────────────────────────────────
       ERROR BREAKDOWN:
      {% set error_counts = {} %}
      {% for error in _scan_errors | default([]) %}
      {% if error.error_code in error_counts %}
      {% set _ = error_counts.update({error.error_code: error_counts[error.error_code] + 1}) %}
      {% else %}
      {% set _ = error_counts.update({error.error_code: 1}) %}
      {% endif %}
      {% endfor %}
      {% for code, count in error_counts.items() %}
         {{ code }}: {{ count }} host(s)
      {% endfor %}
      ───────────────────────────────────────────────────────────────────────────
       Reports saved to: {{ inspec_results_dir }}/
       - error_summary_{{ ansible_date_time.epoch }}.txt
      {% if export_failed_hosts_json | default(true) | bool %}
       - {{ failed_hosts_report_file | default('failed_hosts_summary.json') }}
      {% endif %}
      ═══════════════════════════════════════════════════════════════════════════
  delegate_to: localhost
  run_once: true
  when: (_scan_errors | default([]) | length) > 0

# Send notification if configured (Slack/Email webhook)
- name: "[Error] Send error notification webhook"
  ansible.builtin.uri:
    url: "{{ notification_webhook_url }}"
    method: POST
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      text: |
        *MSSQL Compliance Scan - Failed Hosts Report*
        Total Failed: {{ _failed_hosts | default([]) | length }}
        Timestamp: {{ ansible_date_time.iso8601 }}
        {% for error in _scan_errors | default([])[:5] %}
        • {{ error.mssql_server }}:{{ error.mssql_port }} - {{ error.error_code }}
        {% endfor %}
        {% if (_scan_errors | default([]) | length) > 5 %}
        ... and {{ (_scan_errors | length) - 5 }} more
        {% endif %}
    status_code: [200, 201, 204]
    timeout: 30
  delegate_to: localhost
  run_once: true
  when:
    - notify_on_scan_errors | default(false) | bool
    - notification_webhook_url | default('') != ''
    - (_scan_errors | default([]) | length) > 0
  ignore_errors: true
