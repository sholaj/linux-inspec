---
# InSpec execution tasks for MSSQL - WINRM MODE
# =============================================
# Executes InSpec via WinRM/AD authentication to Windows SQL Server.
# Called from execute.yml when use_winrm is true.
#
# Architecture:
#   Delegate Host (Linux) --[WinRM + AD Auth]--> SQL Server (Windows)
#
# WinRM mode uses Windows/AD authentication to connect directly to the
# SQL Server. The AD credentials (winrm_username/winrm_password) are used
# for both WinRM transport and SQL Server authentication via Windows Auth.

# Verify InSpec is available on delegate
- name: "[WinRM Execute] Verify InSpec binary"
  shell: command -v inspec
  args:
    executable: /bin/bash
  register: _inspec_check
  changed_when: false
  failed_when: _inspec_check.rc != 0
  delegate_to: "{{ _delegate_host }}"

- name: "[WinRM Execute] Set InSpec path"
  set_fact:
    _inspec_bin: "{{ _inspec_check.stdout | trim }}"

# Build WinRM connection string - connects directly to mssql_server
# URL format: winrm://user@host (port 5985 is default, no need to specify)
- name: "[WinRM Execute] Build WinRM target URL"
  set_fact:
    _winrm_target: "winrm://{{ winrm_username }}@{{ mssql_server }}"

- name: "[WinRM Execute] Display WinRM execution info"
  debug:
    msg: |
      WinRM/AD Execution Configuration:
        Target: {{ _winrm_target }}
        AD User: {{ winrm_username }}
        SQL Server: {{ mssql_server }}:{{ mssql_port }}
        Database: {{ mssql_database }}
        Profile: {{ _remote_controls_path }}
  when: inspec_debug_mode | default(false) | bool

# Execute InSpec via WinRM transport with AD authentication
# Windows Auth: Do NOT pass usernm/passwd - the profile detects nil/empty and
# omits credentials from mssql_session, triggering Windows Authentication.
# The WinRM user's Windows identity is used for SQL Server authentication.
- name: "[WinRM Execute] Execute InSpec profile via WinRM/AD"
  shell: |
    export CHEF_LICENSE=accept

    "{{ _inspec_bin }}" exec "{{ _remote_controls_path }}" \
      -t {{ _winrm_target }} \
      --password '{{ winrm_password }}' \
      --input hostnm='localhost' \
              port='{{ mssql_port }}' \
              servicenm='{{ mssql_service | default("") }}' \
      --reporter=json-min \
      --no-color \
      --chef-license=accept
  args:
    executable: /bin/bash
  register: _inspec_profile_result
  changed_when: false
  failed_when: _inspec_profile_result.rc not in [0, 100, 101]
  delegate_to: "{{ _delegate_host }}"
  timeout: "{{ scan_timeout | default(300) }}"
  no_log: true

# Convert single result to list for compatibility with downstream tasks
- name: "[WinRM Execute] Wrap InSpec result for processing"
  set_fact:
    inspec_results:
      results:
        - stdout: "{{ _inspec_profile_result.stdout }}"
          rc: "{{ _inspec_profile_result.rc }}"
          item:
            path: "{{ _remote_controls_path }}"
            connection_mode: "winrm"
            target_server: "{{ mssql_server }}"
