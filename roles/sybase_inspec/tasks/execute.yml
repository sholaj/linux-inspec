---
# Sybase InSpec execution tasks with SSH support
#
# EXECUTION MODES:
# Mode 1: Delegate/Bastion Mode (when inspec_delegate_host is defined)
#   - Layer 1: Ansible SSHs to delegate host using ansible_user (from inventory)
#   - Layer 2: Delegate host SSHs to Sybase server using sybase_ssh_user (for InSpec SSH transport)
#   - Layer 3: InSpec connects to database using sybase_username/sybase_password (from vault)
#
# Mode 2: Local/Direct Mode (when inspec_delegate_host is undefined or empty)
#   - Layer 1: InSpec runs directly on AAP2/local machine
#   - Layer 2: InSpec SSHs to Sybase server using sybase_ssh_user (for InSpec SSH transport)
#   - Layer 3: InSpec connects to database using sybase_username/sybase_password (from vault)
#
# Note: Sybase ALWAYS uses SSH transport for InSpec, regardless of execution mode
# Note: _delegate_host is set in main.yml - do not duplicate here

- name: Gather environment facts from execution target
  ansible.builtin.setup:
    gather_subset:
      - env
  delegate_to: "{{ _delegate_host }}"
  delegate_facts: true

- name: Set target environment from execution host
  ansible.builtin.set_fact:
    _target_env: "{{ hostvars[_delegate_host].ansible_env | default({'PATH': '', 'LD_LIBRARY_PATH': ''}) }}"

- name: Get system PATH from delegate host if not available in facts
  ansible.builtin.shell: echo "$PATH"
  register: delegate_system_path
  changed_when: false
  delegate_to: "{{ _delegate_host }}"
  when: not (_target_env.PATH | default('')) or (_target_env.PATH | default('')) == ''

- name: Update target environment with system PATH
  ansible.builtin.set_fact:
    _target_env: "{{ _target_env | combine({'PATH': delegate_system_path.stdout}) }}"
  when: delegate_system_path.stdout is defined

- name: Build environment variables
  ansible.builtin.set_fact:
    sybase_environment:
      PATH: "{{ sybase_environment_base.PATH }}{% if _target_env.PATH | default('') %}:{{ _target_env.PATH }}{% endif %}"
      LD_LIBRARY_PATH: "{{ sybase_environment_base.LD_LIBRARY_PATH }}{% if _target_env.LD_LIBRARY_PATH | default('') %}:{{ _target_env.LD_LIBRARY_PATH }}{% endif %}"
      SYBASE: "{{ sybase_environment_base.SYBASE }}"
      SYBASE_OCS: "{{ sybase_environment_base.SYBASE_OCS }}"
      SSH_AUTH_SOCK: "{{ _target_env.SSH_AUTH_SOCK | default('') }}"

- name: Display execution info
  ansible.builtin.debug:
    msg: |
      Sybase InSpec Execution Configuration
      =====================================
      Target Server: {{ sybase_server }}:{{ sybase_port }}
      Service Name: {{ sybase_service }}
      Database: {{ sybase_database | default('master') }}
      SSH Mode: {{ sybase_use_ssh | default(true) }}
      Execution Target: {{ _delegate_host }}

      Note: Connectivity will be validated by InSpec's sybase_session resource
  when: inspec_debug_mode | default(false) | bool

- name: Execute Sybase InSpec profile via SSH
  ansible.builtin.shell: |
    # Source Sybase environment
    source {{ sybase_environment_base.SYBASE }}/SYBASE.sh

    inspec exec {{ sybase_profile_path }} \
      --ssh://'{{ sybase_ssh_user }}':'{{ sybase_ssh_password }}'@'{{ sybase_server }}' \
      -o {{ sybase_ssh_key_path }} \
      --input usernm='{{ sybase_username }}' \
              passwd='{{ sybase_password }}' \
              servernm='{{ sybase_service }}' \
              database='{{ sybase_database | default("master") }}' \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  timeout: "{{ scan_timeout | default(600) }}"
  register: sybase_inspec_results
  changed_when: false
  failed_when: sybase_inspec_results.rc not in [0, 100, 101]
  no_log: "{{ not (inspec_debug_mode | default(false)) }}"
  delegate_to: "{{ _delegate_host }}"
  when: sybase_use_ssh | default(true)

- name: Execute InSpec profile (direct mode)
  ansible.builtin.shell: |
    # Source Sybase environment
    source {{ sybase_environment_base.SYBASE }}/SYBASE.sh

    inspec exec {{ sybase_profile_path }} \
      --input usernm='{{ sybase_username }}' \
              passwd='{{ sybase_password }}' \
              servernm='{{ sybase_service }}' \
              database='{{ sybase_database | default("master") }}' \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  timeout: "{{ scan_timeout | default(600) }}"
  register: sybase_inspec_results_direct
  changed_when: false
  failed_when: sybase_inspec_results_direct.rc not in [0, 100, 101]
  no_log: "{{ not (inspec_debug_mode | default(false)) }}"
  delegate_to: "{{ _delegate_host }}"
  when: not (sybase_use_ssh | default(true))

- name: Set results variable for processing
  ansible.builtin.set_fact:
    sybase_final_results: "{{ (sybase_use_ssh | default(true)) | ternary(sybase_inspec_results | default({}), sybase_inspec_results_direct | default({})) }}"

# Parse results for display
- name: Parse Sybase InSpec results
  ansible.builtin.set_fact:
    _parsed_results: "{{ [sybase_final_results.stdout if sybase_final_results.stdout is mapping else (sybase_final_results.stdout | from_json)] }}"
  when: sybase_final_results.stdout is defined and sybase_final_results.stdout != ''
  no_log: true

- name: Display scan summary
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
       Sybase InSpec Compliance Scan Results
       Database: {{ sybase_server }}:{{ sybase_port }}/{{ sybase_service | default('N/A') }}
       Version: {{ sybase_version }}
      ═══════════════════════════════════════════════════════════════════
      {% set ns = namespace(passed=0, failed=0, total=0) %}
      {% for result in _parsed_results | default([]) %}
      {% for control in result.controls | default([]) %}
      {% set res = control.results | default([]) %}
      {% set status = res[0].status | default(control.status | default('unknown')) %}
      {% set ns.total = ns.total + 1 %}
      {% if status == 'passed' %}{% set ns.passed = ns.passed + 1 %}{% elif status == 'failed' %}{% set ns.failed = ns.failed + 1 %}{% endif %}
      {{ control.id }}: {{ status | upper }} - {{ control.title | default('N/A') | truncate(60) }}
      {% endfor %}
      {% endfor %}
      ───────────────────────────────────────────────────────────────────
       Total: {{ ns.total }} | Passed: {{ ns.passed }} | Failed: {{ ns.failed }}
      ═══════════════════════════════════════════════════════════════════
  when: _parsed_results is defined and (_parsed_results | length) > 0

- name: Process Sybase InSpec results
  ansible.builtin.include_tasks: process_results.yml
  vars:
    inspec_result: "{{ sybase_final_results }}"
    profile_name: "sybase-16-cis"
