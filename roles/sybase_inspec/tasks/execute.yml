---
# Sybase InSpec execution tasks with SSH support
#
# EXECUTION MODES:
# Mode 1: Delegate/Bastion Mode (when inspec_delegate_host is defined)
#   - Layer 1: Ansible SSHs to delegate host using ansible_user (from inventory)
#   - Layer 2: Delegate host SSHs to Sybase server using sybase_ssh_user (for InSpec SSH transport)
#   - Layer 3: InSpec connects to database using sybase_username/sybase_password (from vault)
#
# Mode 2: Local/Direct Mode (when inspec_delegate_host is undefined or empty)
#   - Layer 1: InSpec runs directly on AAP2/local machine
#   - Layer 2: InSpec SSHs to Sybase server using sybase_ssh_user (for InSpec SSH transport)
#   - Layer 3: InSpec connects to database using sybase_username/sybase_password (from vault)
#
# Note: Sybase ALWAYS uses SSH transport for InSpec, regardless of execution mode

- name: Determine execution mode and target host
  set_fact:
    use_delegate_host: "{{ (inspec_delegate_host | default('')) not in ['', 'localhost'] }}"
    inspec_execution_target: "{{ inspec_delegate_host if (inspec_delegate_host | default('')) not in ['', 'localhost'] else 'localhost' }}"
    cacheable: yes

- name: Gather environment facts from execution target
  setup:
    gather_subset:
      - env
  delegate_to: "{{ inspec_execution_target }}"
  delegate_facts: true

- name: Set target environment from execution host
  set_fact:
    _target_env: "{{ hostvars[inspec_execution_target].ansible_env | default({'PATH': '', 'LD_LIBRARY_PATH': ''}) }}"

- name: Get system PATH from delegate host if not available in facts
  shell: echo "$PATH"
  register: delegate_system_path
  changed_when: false
  delegate_to: "{{ inspec_execution_target }}"
  when: not _target_env.PATH or _target_env.PATH == ''

- name: Update target environment with system PATH
  set_fact:
    _target_env: "{{ _target_env | combine({'PATH': delegate_system_path.stdout}) }}"
  when: delegate_system_path.stdout is defined

- name: Build environment variables
  set_fact:
    sybase_environment:
      PATH: "{{ sybase_environment_base.PATH }}{% if _target_env.PATH %}:{{ _target_env.PATH }}{% endif %}"
      LD_LIBRARY_PATH: "{{ sybase_environment_base.LD_LIBRARY_PATH }}{% if _target_env.LD_LIBRARY_PATH %}:{{ _target_env.LD_LIBRARY_PATH }}{% endif %}"
      SYBASE_OCS: "{{ sybase_environment_base.SYBASE_OCS }}"
      SSH_AUTH_SOCK: "{{ _target_env.SSH_AUTH_SOCK | default('') }}"

- name: Test database connectivity with isql
  shell: |
    set -e
    
    # Export environment variables explicitly
    export PATH="{{ sybase_environment.PATH }}"
    export LD_LIBRARY_PATH="{{ sybase_environment.LD_LIBRARY_PATH }}"
    export SYBASE="{{ sybase_environment_base.SYBASE }}"
    export SYBASE_OCS="{{ sybase_environment.SYBASE_OCS }}"
    
    # Check if isql is available
    if ! command -v isql &> /dev/null; then
      echo "ERROR: isql command not found in PATH"
      echo "PATH: $PATH"
      exit 127
    fi
    
    echo "Testing connectivity to {{ sybase_server }}:{{ sybase_port }}..."
    
    # Run connectivity test with timeout
    echo "SELECT 'CONNECTION_OK'" | timeout 10 isql -U "{{ sybase_username }}" -P '{{ sybase_password }}' -S "{{ sybase_server }}:{{ sybase_port }}" 2>&1
    
    exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
      echo "SUCCESS: Database connection verified"
    elif [ $exit_code -eq 124 ]; then
      echo "ERROR: Connection timeout after 10 seconds"
      exit 124
    else
      echo "ERROR: Connection failed with exit code $exit_code"
      exit $exit_code
    fi
  args:
    executable: /bin/bash
  register: isql_test
  changed_when: false
  failed_when: false
  delegate_to: "{{ inspec_execution_target }}"
  no_log: true

- name: Fail if database is not reachable
  fail:
    msg: |
      CRITICAL: Cannot connect to Sybase database {{ sybase_server }}:{{ sybase_port }}
      
      Exit Code: {{ isql_test.rc | default('undefined') }}
      
      Diagnostics:
      {{ isql_test.stdout | default('') }}
      
      This could be due to:
      - isql not in PATH (exit code 127)
      - Connection timeout (exit code 124)
      - Incorrect credentials
      - Network connectivity issues
      - Database server not running
      - Interfaces file configuration issues
      - Firewall blocking connection
      
      Current PATH: {{ sybase_environment.PATH }}
      SYBASE: {{ sybase_environment_base.SYBASE }}
      SYBASE_OCS: {{ sybase_environment.SYBASE_OCS }}
  when: 
    - isql_test.rc is defined
    - isql_test.rc != 0

- name: Execute Sybase InSpec controls via SSH
  shell: |
    export PATH="{{ sybase_environment.PATH }}"
    export LD_LIBRARY_PATH="{{ sybase_environment.LD_LIBRARY_PATH }}"
    export SYBASE="{{ sybase_environment.SYBASE }}"
    export SYBASE_OCS="{{ sybase_environment.SYBASE_OCS }}"
    export INSPEC_DB_SERVICE="{{ sybase_service | default('') }}"
    export INSPEC_DB_PORT="{{ sybase_port }}"
    
    inspec exec {{ item.path }} \
      --ssh://'{{ sybase_ssh_user }}':'{{ sybase_ssh_password }}'@'{{ sybase_server }}' \
      -o {{ sybase_ssh_key_path }} \
      --input usernm='{{ sybase_username }}' \
              passwd='{{ sybase_password }}' \
              hostnm='{{ sybase_server }}' \
              servicenm='{{ sybase_service | default("") }}' \
              port='{{ sybase_port }}' \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  register: sybase_inspec_results
  loop: "{{ sybase_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: |
    sybase_inspec_results.rc != 0 and (
      'Cannot connect to' not in sybase_inspec_results.stdout and
      'connection refused' not in sybase_inspec_results.stdout and
      'Connection timeout' not in sybase_inspec_results.stdout
    )
  no_log: true
  async: "{{ inspec_command_timeout | default(1800) }}"
  poll: 30
  delegate_to: "{{ inspec_execution_target }}"
  when: sybase_use_ssh | default(true)

- name: Execute InSpec controls
  shell: |
    export PATH="{{ sybase_environment.PATH }}"
    export LD_LIBRARY_PATH="{{ sybase_environment.LD_LIBRARY_PATH }}"
    export SYBASE="{{ sybase_environment.SYBASE }}"
    export SYBASE_OCS="{{ sybase_environment.SYBASE_OCS }}"
    export INSPEC_DB_SERVICE="{{ sybase_service | default('') }}"
    export INSPEC_DB_PORT="{{ sybase_port }}"
    
    inspec exec {{ item.path }} \
      --input usernm='{{ sybase_username }}' \
              passwd='{{ sybase_password }}' \
              hostnm='{{ sybase_server }}' \
              servicenm='{{ sybase_service | default("") }}' \
              port='{{ sybase_port }}' \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  register: sybase_inspec_results_direct
  loop: "{{ sybase_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: |
    sybase_inspec_results_direct.rc != 0 and (
      'Cannot connect to' not in sybase_inspec_results_direct.stdout and
      'connection refused' not in sybase_inspec_results_direct.stdout and
      'Connection timeout' not in sybase_inspec_results_direct.stdout
    )
  no_log: true
  async: "{{ inspec_command_timeout | default(1800) }}"
  poll: 30
  delegate_to: "{{ inspec_execution_target }}"
  when: not (sybase_use_ssh | default(true))

- name: Set results variable for processing
  set_fact:
    sybase_final_results: "{{
      (sybase_use_ssh | default(true))
        | ternary(sybase_inspec_results | default({}), sybase_inspec_results_direct | default({}))
    }}"

- name: Display sanitized execution summary (debug mode only)
  debug:
    msg: |
      Sybase InSpec Execution Summary
      ===============================
      Database: {{ sybase_server }}:{{ sybase_port }}
      Service: {{ sybase_service | default('N/A') }}
      SSH Mode: {{ sybase_use_ssh | default(true) }}
      {% if sybase_use_ssh | default(true) %}
      SSH User: {{ sybase_ssh_user }}
      SSH Password: [PROTECTED - passed via environment variable]
      {% endif %}
      DB Username: {{ sybase_username }}
      DB Password: [PROTECTED - passed via environment variable]
      Control: {{ item.item.path | basename }}
      Status: {{ 'PASS' if item.rc == 0 else 'FAIL' }}
      Exit Code: {{ item.rc }}
  loop: "{{ sybase_final_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item.path | basename }}"
  when:
    - inspec_debug_mode | default(false)
    - sybase_final_results.results is defined
  delegate_to: "{{ inspec_execution_target }}"

- name: Process Sybase InSpec results
  include_tasks: process_results.yml
  loop: "{{ sybase_final_results.results | default([]) }}"
  loop_control:
    index_var: idx
    label: "Processing Sybase result {{ idx + 1 }}"
  when: sybase_final_results.results is defined
