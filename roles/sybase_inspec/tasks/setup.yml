---
# Setup tasks for Sybase InSpec execution
# Control files are copied ONCE per version to a fixed path, then reused

- name: Determine execution mode for setup
  set_fact:
    use_delegate_host: "{{ inspec_delegate_host is defined and inspec_delegate_host | length > 0 and inspec_delegate_host != 'localhost' }}"
    inspec_execution_target: "{{ inspec_delegate_host if (inspec_delegate_host | default('')) not in ['', 'localhost'] else 'localhost' }}"
    _local_controls_path: "{{ role_path }}/files/SYBASE{{ sybase_version }}_ruby"
    sybase_controls_base_dir: "/tmp/inspec_sybase_{{ sybase_version }}"

- name: Setup Sybase InSpec environment
  block:
    - name: Create Sybase results directory
      file:
        path: "{{ inspec_results_dir }}"
        state: directory
        mode: "0755"

    - name: Create SAP ASE directory structure
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ sybase_environment_base.SYBASE }}"
        - "{{ sybase_environment_base.SYBASE }}/{{ sybase_environment_base.SYBASE_OCS }}/bin"
        - "{{ sybase_environment_base.SYBASE }}/{{ sybase_environment_base.SYBASE_OCS }}/lib"
      become: true

    - name: Deploy SYBASE.sh environment script
      template:
        src: SYBASE.sh.j2
        dest: "{{ sybase_environment_base.SYBASE }}/SYBASE.sh"
        mode: "0755"
      become: true

    - name: Deploy Sybase interfaces file
      template:
        src: interfaces.j2
        dest: "{{ sybase_environment_base.SYBASE }}/interfaces"
        mode: "0644"
      become: true

    # Check if controls already exist (skip copy if present)
    - name: Check if controls already copied
      stat:
        path: "{{ sybase_controls_base_dir }}/SYBASE{{ sybase_version }}_ruby/inspec.yml"
      register: _controls_exist

    # Only copy controls if not already present
    - name: Copy controls to delegate (once per version)
      when: not _controls_exist.stat.exists
      block:
        - name: Create Sybase controls directory
          file:
            path: "{{ sybase_controls_base_dir }}/SYBASE{{ sybase_version }}_ruby"
            state: directory
            mode: "0755"

        - name: Copy Sybase control files
          copy:
            src: "{{ _local_controls_path }}/"
            dest: "{{ sybase_controls_base_dir }}/SYBASE{{ sybase_version }}_ruby/"
            mode: "0644"

        - name: Display setup info
          debug:
            msg: "Copied controls to {{ sybase_controls_base_dir }}"
          when: inspec_debug_mode | default(false) | bool

    - name: Set Sybase InSpec profile path
      set_fact:
        sybase_profile_path: "{{ sybase_controls_base_dir }}/SYBASE{{ sybase_version }}_ruby"
        cacheable: yes

    - name: Verify Sybase InSpec profile exists
      stat:
        path: "{{ sybase_profile_path }}/inspec.yml"
      register: sybase_profile_check

    - name: Display Sybase profile to be executed
      debug:
        msg: |
          Sybase {{ sybase_version }} InSpec Profile
          =========================================
          Profile path: {{ sybase_profile_path }}
          SSH Mode: {{ sybase_use_ssh | default(false) | ternary('Enabled', 'Direct') }}
      when: inspec_debug_mode | default(false) | bool

    - name: Fail if Sybase InSpec profile not found
      fail:
        msg: "Sybase InSpec profile not found at {{ sybase_profile_path }}"
      when: not sybase_profile_check.stat.exists
  delegate_to: "{{ inspec_execution_target }}"
