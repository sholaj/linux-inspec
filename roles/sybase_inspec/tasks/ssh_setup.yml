---
# SSH setup tasks for Sybase InSpec execution
# Based on original script SSH logic: --ssh://oracle:edcp!cv0576@ -o oracle/.ssh/authorized_keys

- name: Gather facts from delegate host for SSH setup
  setup:
  delegate_to: "{{ inspec_delegate_host }}"
  delegate_facts: true

- name: Build Sybase environment variables using delegate host facts
  set_fact:
    sybase_environment:
      PATH: "{{ sybase_environment_base.PATH }}:{{ hostvars[inspec_delegate_host].ansible_env.PATH | default('') }}"
      LD_LIBRARY_PATH: "{{ sybase_environment_base.LD_LIBRARY_PATH }}:{{ hostvars[inspec_delegate_host].ansible_env.LD_LIBRARY_PATH | default('') }}"
      SYBASE: "{{ sybase_environment_base.SYBASE }}"
      SYBASE_OCS: "{{ sybase_environment_base.SYBASE_OCS }}"
      SSH_AUTH_SOCK: "{{ hostvars[inspec_delegate_host].ansible_env.SSH_AUTH_SOCK | default('') }}"

- name: Ensure SSH key directory exists
  file:
    path: "{{ sybase_ssh_key_path | dirname }}"
    state: directory
    mode: '0700'
  delegate_to: "{{ inspec_delegate_host }}"
  when: sybase_ssh_key_path | dirname != '/tmp'

- name: Deploy SSH private key for Sybase access (from vault)
  copy:
    content: "{{ vault_sybase_ssh_private_key | default('# SSH key not provided in vault') }}"
    dest: "{{ sybase_ssh_key_path }}"
    mode: '0600'
  no_log: true
  when: vault_sybase_ssh_private_key is defined
  delegate_to: "{{ inspec_delegate_host }}"

- name: Test SSH connectivity to Sybase host
  shell: |
    ssh -o ConnectTimeout=10 \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -p {{ sybase_ssh_port }} \
        {{ sybase_ssh_user }}@{{ sybase_server }} \
        "echo 'SSH connection test successful'"
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ sybase_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ sybase_environment.LD_LIBRARY_PATH }}"
    SYBASE: "{{ sybase_environment.SYBASE }}"
    SYBASE_OCS: "{{ sybase_environment.SYBASE_OCS }}"
    SSH_AUTH_SOCK: "{{ sybase_environment.SSH_AUTH_SOCK }}"
  register: ssh_test
  changed_when: false
  failed_when: false
  when: sybase_use_ssh | default(true)
  delegate_to: "{{ inspec_delegate_host }}"

- name: Display SSH connection test results
  debug:
    msg: |
      SSH Connection Test for Sybase:
      Target: {{ sybase_ssh_user }}@{{ sybase_server }}:{{ sybase_ssh_port }}
      Status: {{ ssh_test.rc == 0 | ternary('SUCCESS', 'FAILED') }}
      {% if ssh_test.rc != 0 %}
      Error: {{ ssh_test.stderr | default('Unknown SSH error') }}
      {% endif %}
  when:
    - sybase_use_ssh | default(true)
    - inspec_debug_mode | default(false)

# SSH connection string no longer needed - credentials passed via environment variables in execute.yml
