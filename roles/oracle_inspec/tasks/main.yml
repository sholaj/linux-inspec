---
# Main task file for Oracle InSpec role
# Following the same modular pattern as MSSQL role
#
# PREFLIGHT FLOW:
# 1. Run pre-flight checks (port + auth)
# 2. If preflight fails → generate skip report, skip scan
# 3. If preflight passes → execute InSpec controls

- name: Set delegation variables
  set_fact:
    _use_delegate: "{{ (inspec_delegate_host | default('')) not in ['', 'localhost'] }}"
    _delegate_host: "{{ inspec_delegate_host if (inspec_delegate_host | default('')) not in ['', 'localhost'] else 'localhost' }}"

- name: Oracle InSpec Compliance Scan Starting
  debug:
    msg: |
      Oracle InSpec Compliance Scan
      ================================
      Server: {{ oracle_server }}:{{ oracle_port }}
      Database: {{ oracle_database }}
      Service: {{ oracle_service }}
      Version: {{ oracle_version }}
      Username: {{ oracle_username }}
      Execution: {{ 'DELEGATE (' + _delegate_host + ')' if _use_delegate else 'LOCALHOST (target host)' }}

      Starting Oracle InSpec compliance scan...

- name: Validate Oracle connection parameters and environment
  include_tasks: validate.yml

# Step 1: Pre-flight connectivity checks
- name: Run pre-flight connectivity checks
  include_tasks: preflight.yml
  when: preflight_enabled | default(true)
  tags: [preflight, always]

# Step 2: Handle preflight failure - skip scan gracefully
- name: Handle preflight failure
  block:
    - name: Display skip notification
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║  SKIPPING DATABASE - Pre-flight check failed                     ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║  Server:   {{ oracle_server }}:{{ oracle_port }}
          ║  Service:  {{ oracle_service }}
          ║  Database: {{ oracle_database }}
          ║  Reason:   {{ preflight_skip_reason }}
          ║  Code:     {{ preflight_error_code }}
          ╚══════════════════════════════════════════════════════════════════╝

    - name: Fail if continue_on_failure is disabled
      fail:
        msg: "Pre-flight check failed: {{ preflight_skip_reason }} [{{ preflight_error_code }}]. Set preflight_continue_on_failure=true to skip and continue."
      when: not (preflight_continue_on_failure | default(true))

    # Generate skip report and cleanup even when skipping
    - name: Generate skip report and cleanup
      include_tasks: cleanup.yml
  when:
    - preflight_enabled | default(true)
    - not preflight_passed
  tags: [preflight]

# Step 3: Setup - prepare directories and control files (only if preflight passed)
- name: Setup execution environment
  include_tasks: setup.yml
  when: preflight_passed | default(true)
  tags: setup

# Step 4: Execute InSpec scans (only if preflight passed)
# Throttle controls max concurrent scans to prevent delegate host overload
- name: Execute Oracle InSpec controls
  include_tasks: execute.yml
  when: preflight_passed | default(true)
  throttle: "{{ scan_throttle | default(10) }}"
  tags: execute

# Step 5: Cleanup and reporting (always runs - reports skipped databases too)
- name: Process results and cleanup
  include_tasks: cleanup.yml
  tags: cleanup

- name: Oracle InSpec Compliance Scan Complete
  debug:
    msg: |
      [OK] Oracle InSpec scan completed successfully!
      Results directory: {{ inspec_results_dir }}
      Platform: ORACLE
      Database: {{ oracle_database }}
      Version: {{ oracle_version }}
  when: preflight_passed | default(true)
