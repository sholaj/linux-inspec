---
# Oracle InSpec execution tasks
#
# EXECUTION MODES:
# Mode 1: Delegate/Bastion Mode (when inspec_delegate_host is defined)
#   - Ansible SSHs to delegate host using ansible_user (from inventory)
#   - InSpec runs on delegate host
#   - InSpec connects to database using oracle_username/oracle_password (from vault)
#
# Mode 2: Local/Direct Mode (when inspec_delegate_host is undefined or empty)
#   - InSpec runs directly on AAP2 execution node or local machine
#   - InSpec connects to database using oracle_username/oracle_password (from vault)
#
# These are DIFFERENT execution paths based on infrastructure setup

- name: Determine execution mode and target host
  set_fact:
    use_delegate_host: "{{ (inspec_delegate_host | default('')) not in ['', 'localhost'] }}"
    inspec_execution_target: "{{ inspec_delegate_host if (inspec_delegate_host | default('')) not in ['', 'localhost'] else 'localhost' }}"

- name: Gather environment facts from execution target
  setup:
    gather_subset:
      - env
  delegate_to: "{{ inspec_execution_target }}"
  delegate_facts: true

- name: Set target environment from execution host
  set_fact:
    _target_env: "{{ hostvars[inspec_execution_target].ansible_env }}"

- name: Build environment variables
  set_fact:
    oracle_environment:
      PATH: "{{ oracle_environment_base.PATH }}:{{ _target_env.PATH }}"
      LD_LIBRARY_PATH: "{{ oracle_environment_base.LD_LIBRARY_PATH }}:{{ _target_env.LD_LIBRARY_PATH | default('') }}"
      ORACLE_HOME: "{{ oracle_environment_base.ORACLE_HOME }}"
      TNS_ADMIN: "{{ oracle_environment_base.TNS_ADMIN }}"
      INSPEC_BACKEND: "{{ oracle_environment_base.INSPEC_BACKEND }}"
      NLS_LANG: "{{ oracle_environment_base.NLS_LANG }}"

- name: Verify SQL*Plus is available in PATH
  shell: |
    set -e
    echo "Checking for sqlplus in PATH..."
    which sqlplus > /dev/null 2>&1
    echo "âœ“ sqlplus is available"
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ oracle_environment.PATH }}"
  delegate_to: "{{ inspec_execution_target }}"
  changed_when: false
  register: sqlplus_validation
  ignore_errors: true

- name: Fail if SQL*Plus is not available
  fail:
    msg: |
      CRITICAL ERROR: sqlplus not found!
      
      The Oracle InSpec role requires Oracle client tools to be installed.
      Expected tool: sqlplus
      
      Current PATH: {{ oracle_environment.PATH }}
      ORACLE_HOME: {{ oracle_environment.ORACLE_HOME | default('not set') }}
      
      Installation instructions:
      - Download from: https://www.oracle.com/database/technologies/instant-client/linux-x86-64-downloads.html
      - Install Oracle Instant Client (basic, sqlplus)
      - Set ORACLE_HOME environment variable
      
      Verify installation with:
      sqlplus -version
  when: sqlplus_validation is failed

- name: Execute Oracle InSpec controls
  shell: |
    /usr/bin/inspec exec {{ item.path }} \
      --input usernm="$INSPEC_DB_USERNAME" \
              passwd="$INSPEC_DB_PASSWORD" \
              hostnm="$INSPEC_DB_HOST" \
              servicenm="$INSPEC_DB_SERVICE" \
              port="$INSPEC_DB_PORT" \
      --reporter=json-min \
      --no-color
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ oracle_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ oracle_environment.LD_LIBRARY_PATH }}"
    ORACLE_HOME: "{{ oracle_environment.ORACLE_HOME }}"
    TNS_ADMIN: "{{ oracle_environment.TNS_ADMIN }}"
    INSPEC_BACKEND: "{{ oracle_environment.INSPEC_BACKEND }}"
    NLS_LANG: "{{ oracle_environment.NLS_LANG }}"
    INSPEC_DB_USERNAME: "{{ oracle_username }}"
    INSPEC_DB_PASSWORD: "{{ oracle_password }}"
    INSPEC_DB_HOST: "{{ oracle_server }}"
    INSPEC_DB_SERVICE: "{{ oracle_service | default('') }}"
    INSPEC_DB_PORT: "{{ oracle_port }}"
  register: oracle_inspec_results
  loop: "{{ oracle_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: |
    (oracle_inspec_results.rc != 0 and 
     'Cannot connect' not in oracle_inspec_results.stdout and 
     'Unreachable' not in oracle_inspec_results.stdout)
  no_log: true
  async: "{{ inspec_command_timeout | default(1800) }}"
  poll: 30
  delegate_to: "{{ inspec_execution_target }}"

- name: Display sanitized execution summary (debug mode only)
  debug:
    msg: |
      Oracle InSpec Execution Summary
      ===============================
      Database: {{ oracle_server }}:{{ oracle_port }}
      Service: {{ oracle_service | default('N/A') }}
      Username: {{ oracle_username }}
      Password: [PROTECTED - passed via environment variable]
      Control: {{ item.item.path | basename }}
      Status: {{ 'PASS' if item.rc == 0 else 'FAIL' }}
      Exit Code: {{ item.rc }}
  loop: "{{ oracle_inspec_results.results }}"
  loop_control:
    label: "{{ item.item.path | basename }}"
  when: inspec_debug_mode | default(false)
  delegate_to: "{{ inspec_execution_target }}"

- name: Process Oracle InSpec results
  include_tasks: process_results.yml
  loop: "{{ oracle_inspec_results.results }}"
  loop_control:
    index_var: idx
    label: "Processing Oracle result {{ idx + 1 }}"
