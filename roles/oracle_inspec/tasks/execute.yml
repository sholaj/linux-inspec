---
# Oracle InSpec execution tasks
#
# EXECUTION MODES:
# Mode 1: Delegate/Bastion Mode (when inspec_delegate_host is defined)
#   - Ansible SSHs to delegate host using ansible_user (from inventory)
#   - InSpec runs on delegate host
#   - InSpec connects to database using oracle_username/oracle_password (from vault)
#
# Mode 2: Local/Direct Mode (when inspec_delegate_host is undefined or empty)
#   - InSpec runs directly on AAP2 execution node or local machine
#   - InSpec connects to database using oracle_username/oracle_password (from vault)
#
# These are DIFFERENT execution paths based on infrastructure setup

- name: Gather environment facts from execution target
  ansible.builtin.setup:
    gather_subset:
      - env
  delegate_to: "{{ _delegate_host }}"
  delegate_facts: true

- name: Set target environment from execution host
  ansible.builtin.set_fact:
    _target_env: "{{ hostvars[_delegate_host].ansible_env | default({'PATH': '', 'LD_LIBRARY_PATH': ''}) }}"

- name: Get system PATH from delegate host if not available in facts
  ansible.builtin.shell: echo "$PATH"
  register: delegate_system_path
  changed_when: false
  delegate_to: "{{ _delegate_host }}"
  when: not (_target_env.PATH | default('')) or (_target_env.PATH | default('')) == ''

- name: Update target environment with system PATH
  ansible.builtin.set_fact:
    _target_env: "{{ _target_env | combine({'PATH': delegate_system_path.stdout}) }}"
  when: delegate_system_path.stdout is defined

- name: Build environment variables
  ansible.builtin.set_fact:
    oracle_environment:
      PATH: "{{ oracle_extra_path }}:{{ ORACLE_HOME }}/bin{% if _target_env.PATH | default('') %}:{{ _target_env.PATH }}{% endif %}"
      LD_LIBRARY_PATH: "{{ ORACLE_HOME }}/lib{% if _target_env.LD_LIBRARY_PATH | default('') %}:{{ _target_env.LD_LIBRARY_PATH }}{% endif %}"
      ORACLE_HOME: "{{ ORACLE_HOME }}"
      TNS_ADMIN: "{{ oracle_tns_admin | default(ORACLE_HOME + '/network/admin') }}"
      NLS_LANG: "{{ NLS_LANG }}"

- name: Set connection parameters based on TNS mode
  ansible.builtin.set_fact:
    oracle_connection_host: "{{ oracle_tns_alias | default(oracle_service | default('ORCL')) | upper if oracle_use_tns | default(false) | bool else oracle_server }}"
    oracle_connection_service: "{{ '' if oracle_use_tns | default(false) | bool else oracle_service | default('') }}"
    oracle_connection_port: "{{ '' if oracle_use_tns | default(false) | bool else oracle_port }}"

# Note: Database connectivity is validated in preflight.yml
# If we reach here, preflight_passed is true and database is reachable

- name: Execute InSpec controls (TNS mode)
  ansible.builtin.shell: |
    # TNS mode: Use TNS alias for connection
    inspec exec {{ oracle_controls_base_dir }}/ORACLE{{ oracle_version }}_ruby/{{ item.path | basename }} \
      --input usernm='{{ oracle_username }}' \
              passwd='{{ oracle_password }}' \
              hostnm='{{ oracle_server }}' \
              servicenm='{{ oracle_service | default("") }}' \
              port='{{ oracle_port }}' \
              tns_alias='{{ oracle_tns_alias | default(oracle_service | default("ORCL")) | upper }}' \
      --reporter=json-min \
      --no-color
  environment:
    PATH: "{{ oracle_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ oracle_environment.LD_LIBRARY_PATH }}"
    ORACLE_HOME: "{{ oracle_environment.ORACLE_HOME }}"
    TNS_ADMIN: "{{ oracle_environment.TNS_ADMIN }}"
    NLS_LANG: "{{ oracle_environment.NLS_LANG }}"
  args:
    executable: /bin/bash
  timeout: "{{ scan_timeout | default(600) }}"
  register: oracle_inspec_results
  loop: "{{ oracle_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: oracle_inspec_results.rc not in [0, 100, 101]
  no_log: true
  delegate_to: "{{ _delegate_host }}"
  when: oracle_use_tns | default(false) | bool

- name: Execute InSpec controls (Direct mode)
  ansible.builtin.shell: |
    inspec exec {{ oracle_controls_base_dir }}/ORACLE{{ oracle_version }}_ruby/{{ item.path | basename }} \
      --input usernm='{{ oracle_username }}' \
              passwd='{{ oracle_password }}' \
              hostnm='{{ oracle_server }}' \
              servicenm='{{ oracle_service | default("") }}' \
              port='{{ oracle_port }}' \
      --reporter=json-min \
      --no-color
  environment:
    PATH: "{{ oracle_environment.PATH }}"
    LD_LIBRARY_PATH: "{{ oracle_environment.LD_LIBRARY_PATH }}"
    ORACLE_HOME: "{{ oracle_environment.ORACLE_HOME }}"
    TNS_ADMIN: "{{ oracle_environment.TNS_ADMIN }}"
    NLS_LANG: "{{ oracle_environment.NLS_LANG }}"
  args:
    executable: /bin/bash
  timeout: "{{ scan_timeout | default(600) }}"
  register: oracle_inspec_results
  loop: "{{ oracle_control_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false
  failed_when: oracle_inspec_results.rc not in [0, 100, 101]
  no_log: true
  delegate_to: "{{ _delegate_host }}"
  when: not (oracle_use_tns | default(false) | bool)

# Parse results for display
- name: Parse Oracle InSpec results
  ansible.builtin.set_fact:
    _parsed_results: "{{ _parsed_results | default([]) + [item.stdout if item.stdout is mapping else (item.stdout | from_json)] }}"
  loop: "{{ oracle_inspec_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item.path | basename }}"
  when: item.stdout is defined and item.stdout != ''
  no_log: true

- name: Display scan summary
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
       Oracle InSpec Compliance Scan Results
       Database: {{ oracle_server }}:{{ oracle_port }}/{{ oracle_service | default('N/A') }}
       Version: {{ oracle_version }}
      ═══════════════════════════════════════════════════════════════════
      {% set ns = namespace(passed=0, failed=0, total=0) %}
      {% for result in _parsed_results | default([]) %}
      {% for control in result.controls | default([]) %}
      {% set res = control.results | default([]) %}
      {% set status = res[0].status | default(control.status | default('unknown')) %}
      {% set ns.total = ns.total + 1 %}
      {% if status == 'passed' %}{% set ns.passed = ns.passed + 1 %}{% elif status == 'failed' %}{% set ns.failed = ns.failed + 1 %}{% endif %}
      {{ control.id }}: {{ status | upper }} - {{ control.title | default('N/A') | truncate(60) }}
      {% endfor %}
      {% endfor %}
      ───────────────────────────────────────────────────────────────────
       Total: {{ ns.total }} | Passed: {{ ns.passed }} | Failed: {{ ns.failed }}
      ═══════════════════════════════════════════════════════════════════
  when: _parsed_results is defined and (_parsed_results | length) > 0

- name: Process Oracle InSpec results
  ansible.builtin.include_tasks: process_results.yml
  loop: "{{ oracle_inspec_results.results | default([]) }}"
  loop_control:
    index_var: idx
    label: "Processing Oracle result {{ idx + 1 }}"
  when: oracle_inspec_results is defined
