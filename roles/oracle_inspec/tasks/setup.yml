---
# Setup tasks for Oracle InSpec execution
# Control files are copied ONCE per version to a fixed path, then reused

# Set fixed paths (deterministic, not temp)
- name: Set control paths
  ansible.builtin.set_fact:
    _local_controls_path: "{{ role_path }}/files/ORACLE{{ oracle_version }}_ruby"
    oracle_controls_base_dir: "/tmp/inspec_oracle_{{ oracle_version }}"
  cacheable: yes

- name: Create Oracle results directory
  file:
    path: "{{ inspec_results_dir }}"
    state: directory
    mode: "0755"
  delegate_to: "{{ _delegate_host }}"

# Check if controls already exist on delegate (skip copy if present)
- name: Check if controls already copied
  stat:
    path: "{{ oracle_controls_base_dir }}/ORACLE{{ oracle_version }}_ruby/inspec.yml"
  register: _controls_exist
  delegate_to: "{{ _delegate_host }}"

# Only copy controls if not already present
- name: Copy controls to delegate (once per version)
  when: not _controls_exist.stat.exists
  block:
    - name: Find control files for Oracle version
      find:
        paths: "{{ _local_controls_path }}"
        patterns: "*.rb,*.yml"
        recurse: true
      register: oracle_control_files
      delegate_to: localhost

    - name: Validate control files exist
      fail:
        msg: "No control files found in {{ _local_controls_path }}"
      when: oracle_control_files.files | length == 0

    - name: Create Oracle controls directory on delegate
      file:
        path: "{{ oracle_controls_base_dir }}/ORACLE{{ oracle_version }}_ruby"
        state: directory
        mode: "0755"
      delegate_to: "{{ _delegate_host }}"

    - name: Copy Oracle control files to delegate
      copy:
        src: "{{ item.path }}"
        dest: "{{ oracle_controls_base_dir }}/ORACLE{{ oracle_version }}_ruby/"
        mode: "0644"
      loop: "{{ oracle_control_files.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
      delegate_to: "{{ _delegate_host }}"

    - name: Display setup info
      debug:
        msg: "Copied {{ oracle_control_files.files | length }} control(s) to {{ oracle_controls_base_dir }}"
      when: inspec_debug_mode | default(false) | bool

- name: Display reuse info
  debug:
    msg: "Reusing existing controls at {{ oracle_controls_base_dir }}"
  when:
    - _controls_exist.stat.exists
    - inspec_debug_mode | default(false) | bool

# TNS Configuration Support
- name: Setup TNS configuration (when oracle_use_tns is enabled)
  when: oracle_use_tns | default(false) | bool
  block:
    - name: Set TNS_ADMIN directory path
      set_fact:
        oracle_tns_admin_dir: "{{ oracle_tns_admin | default(oracle_temp_dir.path + '/tns_admin') }}"

    - name: Create TNS_ADMIN directory
      file:
        path: "{{ oracle_tns_admin_dir }}"
        state: directory
        mode: "0755"
      delegate_to: "{{ _delegate_host }}"

    - name: Deploy tnsnames.ora from template
      template:
        src: tnsnames.ora.j2
        dest: "{{ oracle_tns_admin_dir }}/tnsnames.ora"
        mode: "0644"
      register: tnsnames_deployed
      delegate_to: "{{ _delegate_host }}"

    - name: Display TNS configuration (debug mode)
      debug:
        msg: |
          TNS Configuration deployed:
          - TNS_ADMIN: {{ oracle_tns_admin_dir }}
          - tnsnames.ora: {{ oracle_tns_admin_dir }}/tnsnames.ora
          - TNS Alias: {{ oracle_tns_alias | default(oracle_service | default('ORCL')) | upper }}
      when: inspec_debug_mode | default(false) | bool

    - name: Update oracle_tns_admin fact for execute tasks
      ansible.builtin.set_fact:
        oracle_tns_admin: "{{ oracle_tns_admin_dir }}"
      cacheable: yes
