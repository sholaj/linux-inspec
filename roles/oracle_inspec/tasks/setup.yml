---
# Setup tasks for Oracle InSpec execution

- name: Determine execution mode for setup
  set_fact:
    use_delegate_host: "{{ inspec_delegate_host is defined and inspec_delegate_host | length > 0 and inspec_delegate_host != 'localhost' }}"
    inspec_execution_target: "{{ inspec_delegate_host if (inspec_delegate_host | default('')) not in ['', 'localhost'] else 'localhost' }}"

- name: Setup Oracle InSpec environment
  block:
    - name: Create Oracle results directory
      file:
        path: "{{ inspec_results_dir }}"
        state: directory
        mode: "0755"

    - name: Create Oracle temporary working directory
      tempfile:
        state: directory
        suffix: "_oracle_inspec"
      register: oracle_temp_dir

    - name: Find all Ruby control files for specified Oracle version
      find:
        paths: "{{ oracle_controls_base_dir }}/ORACLE{{ oracle_version }}_ruby"
        patterns: "*.rb"
        file_type: file
        recurse: true
      register: oracle_control_files_raw

    - name: Cache Oracle control files for execution tasks
      set_fact:
        oracle_control_files: "{{ oracle_control_files_raw }}"
        cacheable: yes

    - name: Display Oracle control files to be executed
      debug:
        msg: |
          Oracle {{ oracle_version }} controls to execute:
          {% for file in oracle_control_files.files %}
          - {{ file.path | basename }}
          {% endfor %}
          Total controls: {{ oracle_control_files.files | length }}
      when: inspec_debug_mode | default(false)

    - name: Fail if no Oracle control files found
      fail:
        msg: "No Oracle control files found in {{ oracle_controls_base_dir }}/ORACLE{{ oracle_version }}_ruby"
      when: oracle_control_files.files | length == 0

    # TNS Configuration Support
    - name: Setup TNS configuration (when oracle_use_tns is enabled)
      when: oracle_use_tns | default(false) | bool
      block:
        - name: Set TNS_ADMIN directory path
          set_fact:
            oracle_tns_admin_dir: "{{ oracle_tns_admin | default(oracle_temp_dir.path + '/tns_admin') }}"

        - name: Create TNS_ADMIN directory
          file:
            path: "{{ oracle_tns_admin_dir }}"
            state: directory
            mode: "0755"

        - name: Deploy tnsnames.ora from template
          template:
            src: tnsnames.ora.j2
            dest: "{{ oracle_tns_admin_dir }}/tnsnames.ora"
            mode: "0644"
          register: tnsnames_deployed

        - name: Display TNS configuration (debug mode)
          debug:
            msg: |
              TNS Configuration deployed:
              - TNS_ADMIN: {{ oracle_tns_admin_dir }}
              - tnsnames.ora: {{ oracle_tns_admin_dir }}/tnsnames.ora
              - TNS Alias: {{ oracle_tns_alias | default(oracle_service | default('ORCL')) | upper }}
          when: inspec_debug_mode | default(false)

        - name: Update oracle_tns_admin fact for execute tasks
          set_fact:
            oracle_tns_admin: "{{ oracle_tns_admin_dir }}"
            cacheable: yes

  delegate_to: "{{ inspec_execution_target }}"
