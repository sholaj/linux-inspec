---
# Oracle cleanup and reporting tasks
#
# Handles both:
# 1. Successful scans - generates compliance summary report
# 2. Skipped databases - generates skip report with reason

# Ensure results directory exists (needed for both scan and skip reports)
- name: Ensure results directory exists
  file:
    path: "{{ inspec_results_dir }}"
    state: directory
    mode: "0755"
  delegate_to: "{{ _delegate_host }}"

# Handle skipped databases (preflight failed)
- name: Generate skip report for failed preflight
  block:
    - name: Create skip report
      template:
        src: skip_report.j2
        dest: "{{ inspec_results_dir }}/SKIPPED_{{ oracle_server | replace('.', '_') }}_{{ oracle_database }}_{{ ansible_date_time.epoch }}.json"
        mode: "0644"
      delegate_to: "{{ _delegate_host }}"

    - name: Display skip summary
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════════
           DATABASE SKIPPED - {{ oracle_server }}:{{ oracle_port }}/{{ oracle_service }}
          ═══════════════════════════════════════════════════════════════════
           Status:     SKIPPED
           Reason:     {{ preflight_skip_reason }}
           Error Code: {{ preflight_error_code }}
           Timestamp:  {{ ansible_date_time.iso8601 }}
          ═══════════════════════════════════════════════════════════════════
  when:
    - not (preflight_passed | default(true))

# Generate summary report (only for successful scans)
- name: Generate and display Oracle summary report
  block:
    - name: Generate Oracle summary report
      template:
        src: oracle_summary_report.j2
        dest: "{{ inspec_results_dir }}/oracle_summary_{{ ansible_date_time.epoch }}.txt"
      register: oracle_summary_report_result

    - name: Read Oracle summary report content
      slurp:
        src: "{{ oracle_summary_report_result.dest }}"
      register: oracle_summary_content

    - name: Display Oracle summary report
      debug:
        msg: "{{ oracle_summary_content.content | b64decode }}"
  when:
    - preflight_passed | default(true)
    - generate_summary_report | default(true)
    - oracle_inspec_results is defined
  ignore_errors: true
  delegate_to: "{{ _delegate_host }}"

# Splunk integration - send scan results (only for successful scans)
- name: Send Oracle results to Splunk (if enabled)
  include_tasks: splunk_integration.yml
  loop: "{{ oracle_inspec_results.results | default([]) }}"
  loop_control:
    loop_var: splunk_result
  vars:
    inspec_result_json: "{{ splunk_result.stdout | default('') }}"
  when:
    - preflight_passed | default(true)
    - send_to_splunk | default(false)
    - splunk_hec_url is defined
    - splunk_hec_token is defined
    - oracle_inspec_results is defined

# Splunk integration - send skip notification
- name: Send skip notification to Splunk
  uri:
    url: "{{ splunk_hec_url }}"
    method: POST
    headers:
      Authorization: "Splunk {{ splunk_hec_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      event:
        type: "database_scan_skipped"
        db_type: "oracle"
        host: "{{ oracle_server }}"
        port: "{{ oracle_port }}"
        database: "{{ oracle_database }}"
        service: "{{ oracle_service }}"
        skip_reason: "{{ preflight_skip_reason }}"
        error_code: "{{ preflight_error_code }}"
        timestamp: "{{ ansible_date_time.iso8601 }}"
        inventory_host: "{{ inventory_hostname }}"
      index: "{{ splunk_index | default('compliance_scans') }}"
      sourcetype: "inspec:skip"
    validate_certs: "{{ splunk_validate_certs | default(true) }}"
    status_code: [200, 201]
  ignore_errors: true
  when:
    - not (preflight_passed | default(true))
    - send_to_splunk | default(false) | bool
    - splunk_hec_url | default('') | length > 0
    - splunk_hec_token | default('') | length > 0
  delegate_to: "{{ _delegate_host }}"

# Clean up temporary files (only for successful scans)
- name: Clean up Oracle temporary files
  file:
    path: "{{ oracle_temp_dir.path }}"
    state: absent
  when:
    - preflight_passed | default(true)
    - oracle_temp_dir is defined
  ignore_errors: true
  delegate_to: "{{ _delegate_host }}"

- name: Clean up Oracle control files directory (remote delegate only)
  file:
    path: "{{ delegate_controls_dir.path }}"
    state: absent
  when:
    - preflight_passed | default(true)
    - delegate_controls_dir is defined
    - delegate_controls_dir.path is defined
  ignore_errors: true
  delegate_to: "{{ _delegate_host }}"

# Display completion summary (only for successful scans)
- name: Display Oracle scan completion summary
  debug:
    msg: |
      Oracle {{ oracle_version }} compliance scan completed
      ====================================================
      Server: {{ oracle_server }}:{{ oracle_port }}
      Database: {{ oracle_database }}
      Service: {{ oracle_service | default('N/A') }}
      Controls executed: {{ oracle_control_files.files | length }}
      Results directory: {{ inspec_results_dir }}
      Platform pattern: ORACLE_NIST_*_{{ oracle_server }}_{{ oracle_database }}_{{ oracle_version }}_*.json
  when:
    - preflight_passed | default(true)
    - oracle_control_files is defined
