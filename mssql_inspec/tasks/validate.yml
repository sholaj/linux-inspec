---
# Validation tasks for MSSQL InSpec role

- name: Handle sensitive connection parameters
  block:
    - name: Set database connection parameters
      set_fact:
        mssql_connection:
          server: "{{ mssql_server }}"
          port: "{{ mssql_port }}"
          database: "{{ mssql_database }}"
          username: "{{ mssql_username }}"
          password: "{{ mssql_password }}"
          version: "{{ mssql_version }}"

    - name: Validate required parameters
      assert:
        that:
          - mssql_server is defined
          - mssql_port is defined
          - mssql_database is defined
          - mssql_username is defined
          - mssql_password is defined
          - mssql_version is defined
        fail_msg: "Required MSSQL connection parameters are missing"
  no_log: true

- name: Determine execution mode for validation
  set_fact:
    use_delegate_host: "{{ inspec_delegate_host is defined and inspec_delegate_host | length > 0 }}"

- name: Check if MSSQL version directory exists (delegate mode)
  stat:
    path: "{{ role_path }}/files/MSSQL{{ mssql_version }}_ruby"
  register: version_dir_check
  delegate_to: "{{ inspec_delegate_host }}"
  when: use_delegate_host | bool

- name: Check if MSSQL version directory exists (local mode)
  stat:
    path: "{{ role_path }}/files/MSSQL{{ mssql_version }}_ruby"
  register: version_dir_check
  when: not (use_delegate_host | bool)

- name: Fail if MSSQL version directory doesn't exist
  fail:
    msg: "MSSQL version {{ mssql_version }} is not supported. Directory MSSQL{{ mssql_version }}_ruby not found."
  when: not version_dir_check.stat.exists