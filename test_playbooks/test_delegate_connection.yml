---
# Test Playbook: Delegate Connection Patterns
# Purpose: Tests delegate_to for both execution and connection scenarios
# Scenarios: Direct connection, jump server connection, delegate connection
# Author: DevOps Team
# Last Updated: 2025-12-14

- name: Test Delegate Connection Patterns for Database Scanning
  hosts: mssql_databases
  gather_facts: no

  vars:
    # Test configuration
    test_scenarios:
      - name: "Non-Delegate Connection"
        description: "Direct connection to target host"
        use_delegate: false
      - name: "Delegate Connection"
        description: "Connection via delegate host"
        use_delegate: true
      - name: "Delegate Execution"
        description: "Execute on delegate, target database from there"
        use_delegate: true

    enable_debug: true

  pre_tasks:
    # Display test overview
    - name: Display test connection scenarios overview
      debug:
        msg: |
          ========================================
          Delegate Connection Pattern Tests
          ========================================
          Purpose: Validate different connection scenarios
          Target Host: {{ inventory_hostname }}
          {% if inspec_delegate_host is defined %}
          Delegate Host: {{ inspec_delegate_host }}
          {% else %}
          Delegate Host: NOT DEFINED (will test direct connection)
          {% endif %}

          Test Scenarios:
          {% for scenario in test_scenarios %}
          {{ loop.index }}. {{ scenario.name }}
             {{ scenario.description }}
          {% endfor %}
          ========================================
      run_once: true
      tags: ['always']

  tasks:
    # Scenario 1: Non-Delegate Connection (Direct)
    - name: "Scenario 1: Test direct connection to database host"
      block:
        - name: Display scenario 1 information
          debug:
            msg: |
              Testing Scenario 1: Non-Delegate Connection
              Target: {{ inventory_hostname }}
              Connection Type: Direct (no delegation)

        - name: Check connectivity to database host directly
          shell: echo "Connected to $(hostname) as $(whoami)"
          args:
            executable: /bin/bash
          register: direct_connection_test
          changed_when: false
          failed_when: false

        - name: Display direct connection results
          debug:
            msg: |
              {% if direct_connection_test.rc == 0 %}
              PASS: Direct connection successful
              Result: {{ direct_connection_test.stdout }}
              {% else %}
              FAIL: Direct connection failed
              Error: {{ direct_connection_test.stderr }}
              {% endif %}
      tags: ['scenario-direct']
      when: enable_debug | bool

    # Scenario 2: Delegate Connection (via delegate host)
    - name: "Scenario 2: Test connection via delegate host"
      block:
        - name: Display scenario 2 information
          debug:
            msg: |
              Testing Scenario 2: Delegate Connection
              Delegate Host: {{ inspec_delegate_host }}
              Purpose: Verify SSH from delegate to database host

        - name: Test SSH from delegate host to database host
          shell: |
            ssh -o ConnectTimeout=5 -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              {{ inventory_hostname }} \
              'echo "Connected to $(hostname) from delegate host"'
          args:
            executable: /bin/bash
          register: delegate_ssh_test
          delegate_to: "{{ inspec_delegate_host }}"
          changed_when: false
          failed_when: false

        - name: Display delegate connection results
          debug:
            msg: |
              {% if delegate_ssh_test.rc == 0 %}
              PASS: Delegate SSH connection successful
              Result: {{ delegate_ssh_test.stdout }}
              {% else %}
              WARN: Delegate SSH connection failed
              This is expected if SSH keys are not configured
              Error: {{ delegate_ssh_test.stderr | default('No error message') }}
              Note: InSpec uses database credentials, not SSH
              {% endif %}
      tags: ['scenario-delegate']
      when:
        - inspec_delegate_host is defined
        - inspec_delegate_host != 'localhost'

    # Scenario 3: Delegate Execution Pattern (InSpec scan pattern)
    - name: "Scenario 3: Test delegate execution pattern for InSpec scans"
      block:
        - name: Display scenario 3 information
          debug:
            msg: |
              Testing Scenario 3: Delegate Execution Pattern
              This mimics actual InSpec scan execution:
              - Task runs on delegate host
              - InSpec connects to database using credentials
              - Results collected on delegate host

        - name: Gather delegate host facts for scan environment
          setup:
          delegate_to: "{{ inspec_delegate_host }}"
          delegate_facts: true

        - name: Build scan environment on delegate host
          set_fact:
            scan_environment:
              PATH: "/opt/mssql-tools/bin:{{ hostvars[inspec_delegate_host].ansible_env.PATH }}"
              HOME: "{{ hostvars[inspec_delegate_host].ansible_env.HOME }}"
              HOSTNAME: "{{ hostvars[inspec_delegate_host].ansible_hostname }}"

        - name: Verify InSpec can be executed on delegate host
          shell: |
            command -v inspec >/dev/null 2>&1 && inspec --version || echo "InSpec not found"
          args:
            executable: /bin/bash
          environment: "{{ scan_environment }}"
          register: inspec_execution_test
          delegate_to: "{{ inspec_delegate_host }}"
          changed_when: false
          failed_when: false

        - name: Display delegate execution results
          debug:
            msg: |
              Delegate Execution Pattern Test Results:
              =========================================
              Delegate Host: {{ hostvars[inspec_delegate_host].ansible_hostname }}
              PATH: {{ scan_environment.PATH[:80] }}...
              {% if 'not found' not in inspec_execution_test.stdout %}
              PASS: InSpec available - {{ inspec_execution_test.stdout }}
              {% else %}
              FAIL: InSpec not found on delegate host
              {% endif %}

              This pattern allows:
              - Execution on delegate host (with InSpec installed)
              - Connection to database using DB credentials
              - No SSH required between delegate and database
      tags: ['scenario-execution']
      when:
        - inspec_delegate_host is defined
        - inspec_delegate_host != 'localhost'

    # Scenario 4: Test jump server/bastion pattern
    - name: "Scenario 4: Test jump server (bastion) configuration"
      block:
        - name: Display jump server scenario information
          debug:
            msg: |
              Testing Scenario 4: Jump Server Pattern
              Checking for ProxyJump/bastion configuration

        - name: Check for jump server configuration in SSH args
          debug:
            msg: |
              Jump Server Configuration:
              {% if ansible_ssh_common_args is defined %}
              DETECTED: SSH ProxyJump/Bastion configured
              SSH Args: {{ ansible_ssh_common_args }}

              This means connections route through a jump server.
              The InSpec delegate pattern handles this automatically.
              {% else %}
              INFO: No jump server configuration detected
              Connections are direct (or handled at network level)
              {% endif %}

              {% if ansible_ssh_private_key_file is defined %}
              SSH Key: {{ ansible_ssh_private_key_file }}
              {% endif %}

        - name: Test connection through jump server (if configured)
          shell: echo "Connection test from $(hostname)"
          args:
            executable: /bin/bash
          register: jump_server_test
          changed_when: false
          failed_when: false

        - name: Display jump server test results
          debug:
            msg: |
              {% if jump_server_test.rc == 0 %}
              PASS: Connection successful (via jump server if configured)
              Result: {{ jump_server_test.stdout }}
              {% else %}
              WARN: Connection test failed
              Error: {{ jump_server_test.stderr | default('No error') }}
              {% endif %}
      tags: ['scenario-jump-server']

    # Scenario 5: Test environment variable loading in non-interactive sessions
    - name: "Scenario 5: Test environment variable loading for non-interactive SSH"
      block:
        - name: Display scenario 5 information
          debug:
            msg: |
              Testing Scenario 5: Non-Interactive SSH Environment
              Issue: Environment variables may not load in non-interactive sessions
              Solution: Explicitly source profile or set variables in tasks

        - name: Test environment in interactive vs non-interactive session
          shell: |
            # Test 1: Non-interactive (Ansible default)
            NON_INTERACTIVE_PATH=$PATH

            # Test 2: Explicitly load profile
            source /etc/profile 2>/dev/null || true
            source ~/.bash_profile 2>/dev/null || true
            INTERACTIVE_PATH=$PATH

            echo "Non-interactive PATH length: ${#NON_INTERACTIVE_PATH}"
            echo "Interactive PATH length: ${#INTERACTIVE_PATH}"

            if [ "${#INTERACTIVE_PATH}" -gt "${#NON_INTERACTIVE_PATH}" ]; then
              echo "DIFFERENCE_DETECTED: Profile loading adds to PATH"
            else
              echo "NO_DIFFERENCE: PATH is same in both modes"
            fi
          args:
            executable: /bin/bash
          register: env_loading_test
          delegate_to: "{{ inspec_delegate_host }}"
          changed_when: false
          failed_when: false

        - name: Display environment loading results
          debug:
            msg: |
              Environment Loading Test Results:
              ==================================
              {{ env_loading_test.stdout }}

              Recommendation:
              {% if 'DIFFERENCE_DETECTED' in env_loading_test.stdout %}
              IMPORTANT: Environment variables differ between interactive/non-interactive
              Solution implemented in roles:
              - Explicitly set PATH and LD_LIBRARY_PATH in tasks
              - Use 'executable: /bin/bash' for shell tasks
              - Source required profiles in shell commands if needed
              {% else %}
              OK: Environment is consistent
              Non-interactive sessions have same PATH as interactive
              {% endif %}
      tags: ['scenario-env-loading']
      when:
        - inspec_delegate_host is defined
        - inspec_delegate_host != 'localhost'

  post_tasks:
    # Comprehensive summary of all scenarios
    - name: Display comprehensive connection pattern test summary
      debug:
        msg: |
          ========================================
          CONNECTION PATTERN TEST SUMMARY
          ========================================
          Target Host: {{ inventory_hostname }}
          {% if inspec_delegate_host is defined %}
          Delegate Host: {{ inspec_delegate_host }}
          {% endif %}

          Scenario Results:
          -----------------
          {% if direct_connection_test is defined %}
          1. Direct Connection: {{ 'PASS' if direct_connection_test.rc == 0 else 'FAIL' }}
          {% endif %}

          {% if delegate_ssh_test is defined %}
          2. Delegate SSH: {{ 'PASS' if delegate_ssh_test.rc == 0 else 'WARN (expected if no SSH keys)' }}
          {% endif %}

          {% if inspec_execution_test is defined %}
          3. Delegate Execution: {{ 'PASS' if ('not found' not in inspec_execution_test.stdout) else 'FAIL' }}
          {% endif %}

          {% if jump_server_test is defined %}
          4. Jump Server Pattern: {{ 'PASS' if jump_server_test.rc == 0 else 'WARN' }}
          {% endif %}

          {% if env_loading_test is defined %}
          5. Environment Loading: {{ 'PASS (differences handled)' if 'DIFFERENCE' in env_loading_test.stdout else 'PASS (consistent)' }}
          {% endif %}

          Key Findings:
          -------------
          Supported Scenarios:
          {% if inspec_delegate_host is defined and inspec_delegate_host != 'localhost' %}
          - Delegate Execution: YES (recommended for InSpec scans)
          - Jump Server Support: {{ 'YES' if ansible_ssh_common_args is defined else 'N/A (direct connection)' }}
          - Environment Handling: IMPLEMENTED (explicit variable setting)
          {% else %}
          - Direct Execution: YES (localhost/direct mode)
          {% endif %}

          Recommended Pattern for Production:
          -----------------------------------
          Use Delegate Execution Pattern:
          - InSpec runs on delegate host (with database tools installed)
          - InSpec connects to database using DB credentials (not SSH)
          - Results stored on delegate host
          - No SSH required between delegate and database hosts
          - Jump servers handled transparently by Ansible

          This pattern works for all scenarios:
          - Single region (no jump server)
          - Multi-region (with jump servers)
          - AAP mesh architecture

          Next Steps:
          -----------
          - Use run_compliance_scans.yml for production scans
          - Ensure InSpec and DB tools installed on delegate host
          - Configure database credentials in vault
          - Test with actual database connections
          ========================================
      run_once: true
      tags: ['test-summary']

# Usage Examples:
# ===============
# Run all connection tests:
#   ansible-playbook -i test_inventory.yml test_playbooks/test_delegate_connection.yml
#
# Test specific scenario:
#   ansible-playbook -i test_inventory.yml test_playbooks/test_delegate_connection.yml --tags scenario-delegate
#
# Debug mode:
#   ansible-playbook -i test_inventory.yml test_playbooks/test_delegate_connection.yml -e "enable_debug=true" -vv
#
# Check mode:
#   ansible-playbook -i test_inventory.yml test_playbooks/test_delegate_connection.yml --check
#
# Test with jump server:
#   ansible-playbook -i test_inventory.yml test_playbooks/test_delegate_connection.yml \
#     -e "ansible_ssh_common_args='-o ProxyJump=jumpserver.example.com'"
#
# Required Inventory Configuration:
# ==================================
# all:
#   children:
#     mssql_databases:
#       hosts:
#         sqlserver01:
#           ansible_host: sqlserver01.example.com
#           inspec_delegate_host: inspec-delegate
#           # Optional jump server config:
#           # ansible_ssh_common_args: '-o ProxyJump=jumpserver.example.com'
#
#     delegate_hosts:
#       hosts:
#         inspec-delegate:
#           ansible_host: delegate.example.com
#           ansible_connection: ssh
#           ansible_user: ansible_user
