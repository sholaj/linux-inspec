---
# Test Playbook: MSSQL InSpec - Delegate Execution (AAP2)
#
# PURPOSE: Validates mssql_inspec role in DELEGATE mode
#          Ansible SSHs to delegate host, InSpec runs there
#
# AAP2 SETUP:
#   - Machine Credential: SSH to delegate host (injects ansible_user/ansible_password)
#   - Custom Credential: Database password (injects mssql_password)
#   - Delegate host needs: InSpec, sqlcmd, network access to DB

# Play 1: Setup inventory
- name: Initialize test inventory
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Add delegate host
      add_host:
        name: "inspec-runner"
        ###########################################
        # UPDATE THESE VALUES FOR YOUR ENVIRONMENT
        ###########################################
        ansible_host: "your-delegate-host.example.com"
        ansible_connection: ssh
        ansible_ssh_common_args: "-o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/dev/null"
        # ansible_user: injected by AAP2 machine credential
        # ansible_password: injected by AAP2 machine credential

    - name: Add test MSSQL target
      add_host:
        name: "test_mssql_01"
        groups: mssql_databases
        ###########################################
        # UPDATE THESE VALUES FOR YOUR ENVIRONMENT
        ###########################################
        mssql_server: "your-mssql-server.example.com"
        mssql_port: 1433
        mssql_version: "2019"
        mssql_username: "nist_scan_user"
        database_platform: mssql
        inspec_delegate_host: "inspec-runner"
        # mssql_password: injected by AAP2 custom credential

# Play 2: Run MSSQL InSpec scan via delegate
- name: Test MSSQL InSpec - Delegate Execution
  hosts: mssql_databases
  gather_facts: no

  vars:
    # Role configuration
    base_results_dir: /tmp/compliance_scans
    inspec_debug_mode: true
    inspec_command_timeout: 1800

  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - mssql_server is defined
          - mssql_username is defined
          - mssql_password is defined
          - mssql_password | length > 0
          - hostvars[inventory_hostname]['inspec_delegate_host'] is defined
          - hostvars[inventory_hostname]['inspec_delegate_host'] | length > 0
        fail_msg: "Missing variables - ensure AAP2 credentials are attached and inspec_delegate_host is set"

    - name: Wait for delegate host connection
      wait_for_connection:
        timeout: 30
      delegate_to: "{{ inspec_delegate_host }}"

    - name: Test network connectivity from delegate to MSSQL server
      wait_for:
        host: "{{ mssql_server }}"
        port: "{{ mssql_port }}"
        state: started
        timeout: 10
      register: network_test
      delegate_to: "{{ inspec_delegate_host }}"
      ignore_errors: yes

    - name: Display network test result
      debug:
        msg: |
          Network Test (from {{ inspec_delegate_host }}): {{ 'PASS - Port ' ~ mssql_port ~ ' is reachable' if network_test is succeeded else 'FAIL - Cannot reach ' ~ mssql_server ~ ':' ~ mssql_port }}

    - name: Fail if network connectivity is not available
      fail:
        msg: |
          Delegate host {{ inspec_delegate_host }} cannot reach {{ mssql_server }}:{{ mssql_port }}
          Please verify:
          - MSSQL server is running
          - Firewall allows traffic on port {{ mssql_port }}
          - Network routing from delegate to database is correct
          - Delegate host has network access to the database
      when: network_test is failed

    - name: Check InSpec version on delegate
      command: /usr/bin/inspec version
      register: inspec_check
      changed_when: false
      delegate_to: "{{ inspec_delegate_host }}"

    - name: Check for sqlcmd availability on delegate
      command: which sqlcmd
      register: sqlcmd_check
      changed_when: false
      ignore_errors: yes
      delegate_to: "{{ inspec_delegate_host }}"

    - name: Get sqlcmd version on delegate
      command: sqlcmd -? 2>&1 | head -1
      register: sqlcmd_version
      changed_when: false
      ignore_errors: yes
      delegate_to: "{{ inspec_delegate_host }}"
      when: sqlcmd_check is succeeded

    - name: Fail if sqlcmd is not available on delegate
      fail:
        msg: |
          sqlcmd not found on delegate host {{ inspec_delegate_host }}!
          This is CRITICAL for MSSQL InSpec scans.
          
          Please install Microsoft SQL Server tools on {{ inspec_delegate_host }}:
          - RHEL/CentOS: sudo yum install mssql-tools
          - Ubuntu/Debian: sudo apt-get install mssql-tools
          - Or download from: https://learn.microsoft.com/en-us/sql/tools/sqlcmd-utility
          
          The InSpec role requires: /opt/mssql-tools/bin/sqlcmd
      when: sqlcmd_check is failed

    - name: Display configuration
      debug:
        msg: |
          Mode: DELEGATE ({{ inspec_delegate_host }}) | DB: {{ mssql_server }}:{{ mssql_port }} | InSpec: {{ inspec_check.stdout_lines[0] }}
          sqlcmd: ✓ Available ({{ sqlcmd_version.stdout | default('version check failed') }})
          Network: ✓ Reachable

  roles:
    - role: mssql_inspec

  post_tasks:
    - name: Test complete
      debug:
        msg: "Results on delegate: {{ base_results_dir }}"
