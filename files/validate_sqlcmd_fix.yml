---
# validate_sqlcmd_fix.yml
# Validation playbook to confirm the sqlcmd PATH fix works correctly
#
# Usage:
#   ansible-playbook -i inventory.yml validate_sqlcmd_fix.yml \
#     -e "inspec_delegate_host=<DELEGATE_HOST>" \
#     -e "mssql_server=<MSSQL_SERVER>" \
#     -e "mssql_port=1733" \
#     -e "mssql_username=<USERNAME>" \
#     -e "mssql_password=<PASSWORD>"
#
# This playbook validates:
#   1. sqlcmd is accessible with PATH export
#   2. Database connectivity works
#   3. InSpec can execute with the fix applied

- name: Validate sqlcmd PATH Fix
  hosts: localhost
  gather_facts: yes
  
  vars:
    # Delegate host configuration
    inspec_delegate_host: "{{ inspec_delegate_host | default('localhost') }}"
    
    # Database connection parameters (override with -e)
    mssql_server: "{{ mssql_server | default('localhost') }}"
    mssql_port: "{{ mssql_port | default('1433') }}"
    mssql_username: "{{ mssql_username | default('sa') }}"
    mssql_password: "{{ mssql_password | default('') }}"
    mssql_service: "{{ mssql_service | default('') }}"
    
    # Environment paths - CUSTOMIZE THESE FOR YOUR ENVIRONMENT
    sqlcmd_bin_path: "/opt/mssql-tools/bin"
    sybase_bin_path: "/tools/ver/sybase/OCS-16_0/bin"
    oracle_lib_path: "/tools/ver/oracle-19.16.0.0-64"
    
    # Combined PATH export string
    path_export: "{{ sqlcmd_bin_path }}:{{ sybase_bin_path }}:/usr/local/bin:/usr/bin:/bin"

  tasks:
    - name: "=========================================="
      debug:
        msg: "VALIDATION TEST 1: SQLCMD ACCESSIBILITY"

    - name: Test sqlcmd with PATH export
      shell: |
        export PATH={{ path_export }}:$PATH
        sqlcmd -? 2>&1 | head -1
      args:
        executable: /bin/bash
      register: sqlcmd_test
      delegate_to: "{{ inspec_delegate_host }}"
      changed_when: false
      failed_when: false

    - name: Display sqlcmd test result
      debug:
        msg: "{{ sqlcmd_test.rc == 0 | ternary('âœ… PASSED: sqlcmd is accessible', 'âŒ FAILED: ' + sqlcmd_test.stderr | default(sqlcmd_test.stdout)) }}"

    - name: Fail if sqlcmd not accessible
      fail:
        msg: |
          sqlcmd is not accessible even with PATH export.
          Please verify sqlcmd is installed at {{ sqlcmd_bin_path }}/sqlcmd
      when: sqlcmd_test.rc != 0

    - name: "=========================================="
      debug:
        msg: "VALIDATION TEST 2: DATABASE CONNECTIVITY"

    - name: Skip database test if no password provided
      debug:
        msg: "âš ï¸  Skipping database connectivity test - no password provided"
      when: mssql_password == ''

    - name: Test database connectivity with sqlcmd
      shell: |
        export PATH={{ path_export }}:$PATH
        sqlcmd -S {{ mssql_server }},{{ mssql_port }} \
               -U {{ mssql_username }} \
               -P '{{ mssql_password }}' \
               -Q "SELECT @@VERSION" \
               -h -1 -W 2>&1 | head -3
      args:
        executable: /bin/bash
      register: db_connectivity_test
      delegate_to: "{{ inspec_delegate_host }}"
      changed_when: false
      failed_when: false
      no_log: true
      when: mssql_password != ''

    - name: Display database connectivity result
      debug:
        msg: |
          Database Connectivity Test:
          {{ db_connectivity_test.rc == 0 | ternary('âœ… PASSED: Connected to ' + mssql_server + ':' + mssql_port | string, 'âŒ FAILED: Could not connect') }}
      when: mssql_password != ''

    - name: "=========================================="
      debug:
        msg: "VALIDATION TEST 3: INSPEC SUBPROCESS INHERITANCE"

    - name: Simulate InSpec execution pattern
      shell: |
        export PATH={{ path_export }}:$PATH
        export LD_LIBRARY_PATH={{ oracle_lib_path }}
        
        # Simulate what InSpec does - spawn a subprocess
        /bin/bash -c 'echo "Subprocess PATH: $PATH" && which sqlcmd'
      args:
        executable: /bin/bash
      register: subprocess_test
      delegate_to: "{{ inspec_delegate_host }}"
      changed_when: false
      failed_when: false

    - name: Display subprocess inheritance result
      debug:
        msg: |
          Subprocess PATH Inheritance Test:
          {{ subprocess_test.rc == 0 | ternary('âœ… PASSED: Subprocess can find sqlcmd', 'âŒ FAILED: Subprocess cannot find sqlcmd') }}
          
          Output:
          {{ subprocess_test.stdout }}

    - name: "=========================================="
      debug:
        msg: "VALIDATION TEST 4: FULL INSPEC COMMAND SIMULATION"

    - name: Create temporary test control file
      copy:
        content: |
          # Temporary test control
          title 'MSSQL Connection Test'
          
          control 'mssql-connection-test' do
            impact 1.0
            title 'Test MSSQL Connection'
            desc 'Verify sqlcmd can connect to database'
            
            describe command('echo "Connection test passed"') do
              its('exit_status') { should eq 0 }
            end
          end
        dest: /tmp/test_control.rb
        mode: '0644'
      delegate_to: "{{ inspec_delegate_host }}"

    - name: Execute InSpec with PATH export (full simulation)
      shell: |
        export PATH={{ path_export }}:$PATH
        export LD_LIBRARY_PATH={{ oracle_lib_path }}
        
        /usr/bin/inspec exec /tmp/test_control.rb \
          --reporter=json-min \
          --no-color 2>&1
      args:
        executable: /bin/bash
      register: inspec_simulation
      delegate_to: "{{ inspec_delegate_host }}"
      changed_when: false
      failed_when: false

    - name: Display InSpec simulation result
      debug:
        msg: |
          InSpec Execution Test:
          {{ inspec_simulation.rc == 0 | ternary('âœ… PASSED: InSpec executed successfully', 'âš ï¸  InSpec returned non-zero (may still be working)') }}
          
          Return Code: {{ inspec_simulation.rc }}

    - name: Cleanup temporary test file
      file:
        path: /tmp/test_control.rb
        state: absent
      delegate_to: "{{ inspec_delegate_host }}"

    - name: "=========================================="
      debug:
        msg: "VALIDATION SUMMARY"

    - name: Display final validation summary
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                   VALIDATION SUMMARY                         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                              â•‘
          â•‘  Test 1 - sqlcmd Accessibility:                              â•‘
          â•‘    {{ sqlcmd_test.rc == 0 | ternary('âœ… PASSED', 'âŒ FAILED') | center(54) }}â•‘
          â•‘                                                              â•‘
          â•‘  Test 2 - Database Connectivity:                             â•‘
          {% if mssql_password == '' %}
          â•‘    {{ 'âš ï¸  SKIPPED (no password)' | center(54) }}â•‘
          {% else %}
          â•‘    {{ db_connectivity_test.rc == 0 | ternary('âœ… PASSED', 'âŒ FAILED') | center(54) }}â•‘
          {% endif %}
          â•‘                                                              â•‘
          â•‘  Test 3 - Subprocess Inheritance:                            â•‘
          â•‘    {{ subprocess_test.rc == 0 | ternary('âœ… PASSED', 'âŒ FAILED') | center(54) }}â•‘
          â•‘                                                              â•‘
          â•‘  Test 4 - InSpec Execution:                                  â•‘
          â•‘    {{ inspec_simulation.rc == 0 | ternary('âœ… PASSED', 'âš ï¸  CHECK OUTPUT') | center(54) }}â•‘
          â•‘                                                              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                              â•‘
          {% if sqlcmd_test.rc == 0 and subprocess_test.rc == 0 %}
          â•‘  âœ… ALL CRITICAL TESTS PASSED                                â•‘
          â•‘                                                              â•‘
          â•‘  The PATH export fix is working correctly.                   â•‘
          â•‘  You can now update your execute.yml with confidence.        â•‘
          {% else %}
          â•‘  âŒ SOME TESTS FAILED                                        â•‘
          â•‘                                                              â•‘
          â•‘  Please review the failed tests above and ensure:            â•‘
          â•‘  - sqlcmd is installed at {{ sqlcmd_bin_path }}/sqlcmd       â•‘
          â•‘  - The delegate host is accessible                           â•‘
          {% endif %}
          â•‘                                                              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          NEXT STEPS:
          ===========
          1. Update mssql_inspec/tasks/execute.yml with the fixed version
          2. Run a test scan against a single database
          3. Validate results in AAP2

    - name: Set validation result
      set_fact:
        validation_passed: "{{ sqlcmd_test.rc == 0 and subprocess_test.rc == 0 }}"

    - name: Final status
      debug:
        msg: "{{ validation_passed | ternary('ğŸ‰ Validation PASSED - Ready to apply fix!', 'âš ï¸  Validation had issues - review output above') }}"
