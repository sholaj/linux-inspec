---
# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║           UNIFIED INVENTORY - Database Compliance Scanning                   ║
# ║                                                                              ║
# ║  This inventory demonstrates BOTH execution modes:                          ║
# ║    - LOCAL: InSpec runs on AAP execution environment                        ║
# ║    - DELEGATE: InSpec runs on remote delegate host via SSH                  ║
# ║                                                                              ║
# ║  Choose your execution mode by setting inspec_delegate_host value           ║
# ║                                                                              ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

# ════════════════════════════════════════════════════════════════════════════════
# SECTION 1: DELEGATE HOST (for delegate execution mode only)
# ════════════════════════════════════════════════════════════════════════════════
# Define the remote delegate/bastion/jump host where InSpec will execute
# (Optional - only needed if using delegate mode, can be omitted for local mode)

all:
  hosts:
    # ────────────────────────────────────────────────────────────────────────
    # Host Definition: Remote Delegate/Bastion Host
    # ────────────────────────────────────────────────────────────────────────
    inspec-runner:
      # IP address or hostname of delegate host
      ansible_host: delegate-host.example.com

      # MUST be 'ssh' for remote execution (not 'local')
      ansible_connection: ssh

      # SSH username to authenticate with delegate
      ansible_user: ansible_svc

      # ══════════════════════════════════════════════════════════════════════
      # SSH AUTHENTICATION: Choose ONE method
      # ══════════════════════════════════════════════════════════════════════

      # OPTION A: SSH Private Key (Recommended for Production)
      # ───────────────────────────────────────────────────
      # Most secure method. Use SSH keys instead of passwords.
      # In AAP: Store private key in Machine Credential, AAP injects it.
      #
      ansible_ssh_private_key_file: /path/to/ansible_inspec_rsa
      #
      # Note: AAP will override this when Machine Credential is attached
      #       The above is for local testing with Ansible directly

      # OPTION B: SSH Password Authentication (Testing/Dev Only)
      # ──────────────────────────────────────────────────────────
      # Less secure, for development/testing environments only.
      # In AAP: Password stored in Machine Credential vault, never exposed
      #
      # Uncomment to use password instead of key:
      # ansible_password: "{{ vault_delegate_password }}"
      #
      # This references a vault file value (for local testing):
      # Keep vault file out of version control!

      # ══════════════════════════════════════════════════════════════════════
      # SSH HOST KEY VERIFICATION
      # ══════════════════════════════════════════════════════════════════════
      # Control how strictly SSH host keys are verified

      ansible_ssh_common_args: "-o StrictHostKeyChecking=accept-new"

      # OPTIONS:
      #   accept-new = Auto-accept new host keys, reject if changed (recommended)
      #   yes = Require host key in known_hosts, strict (most secure)
      #   no = Never verify host keys (insecure - DO NOT USE in production)

      # ══════════════════════════════════════════════════════════════════════
      # OPTIONAL: Connection Timeouts
      # ══════════════════════════════════════════════════════════════════════
      # ansible_timeout: 30  # seconds to wait for SSH response
      # ansible_port: 22     # SSH port (default is 22)

  # ════════════════════════════════════════════════════════════════════════════════
  # SECTION 2: DATABASE GROUPS
  # ════════════════════════════════════════════════════════════════════════════════
  # Define your database servers and execution parameters

  children:
    # ────────────────────────────────────────────────────────────────────────
    # GROUP 1: MSSQL Database Servers
    # ────────────────────────────────────────────────────────────────────────
    # SQL Server 2017, 2019, 2022 instances

    mssql_databases:
      hosts:
        # MSSQL Server 1 (Production)
        mssql_prod_01:
          # Database connection parameters
          mssql_server: prod-mssql-01.internal.com
          mssql_port: 1433
          mssql_version: "2019"
          database_platform: mssql

          # Optional: Override execution results directory
          # inspec_results_dir: "/tmp/mssql_prod_01_results"

        # MSSQL Server 2 (Development)
        mssql_dev_01:
          mssql_server: dev-mssql.internal.com
          mssql_port: 1433
          mssql_version: "2017"
          database_platform: mssql

        # MSSQL Server 3 (Different Port)
        mssql_prod_02:
          mssql_server: prod-mssql-02.internal.com
          mssql_port: 1500 # Non-standard port
          mssql_version: "2022"
          database_platform: mssql

      vars:
        # ════════════════════════════════════════════════════════════════════
        # EXECUTION MODE SELECTION
        # ════════════════════════════════════════════════════════════════════
        # This ONE variable controls where InSpec executes

        # ╔─────────────────────────────────────────────────────────────────╗
        # ║ MODE: DELEGATE - InSpec runs on remote host (via SSH)           ║
        # ║                                                                 ║
        # ║ Use when: AAP cannot reach databases (firewall), need bastion  ║
        # ╚─────────────────────────────────────────────────────────────────╝
        inspec_delegate_host: "inspec-runner"

        # Uncomment below for LOCAL mode instead:
        # ╔─────────────────────────────────────────────────────────────────╗
        # ║ MODE: LOCAL - InSpec runs on AAP execution environment          ║
        # ║                                                                 ║
        # ║ Use when: AAP has network access to databases, no bastion      ║
        # ╚─────────────────────────────────────────────────────────────────╝
        # inspec_delegate_host: ""  # Empty string = local mode
        # or
        # inspec_delegate_host: "localhost"  # Explicitly localhost

        # ════════════════════════════════════════════════════════════════════
        # DATABASE CREDENTIALS
        # ════════════════════════════════════════════════════════════════════
        # These credentials are for InSpec → Database connection
        # (DIFFERENT from SSH credentials for delegate host)

        mssql_username: nist_scan_user
        # mssql_password: DO NOT PUT IN INVENTORY
        #   ↓ Instead, inject via AAP Custom Credential
        #   ↓ In AAP: Job Template → Credentials → Attach MSSQL Custom Credential
        #   ↓ AAP automatically injects mssql_password at runtime
        #   ↓ For LOCAL testing: Use vault file (see vault section below)

        # ════════════════════════════════════════════════════════════════════
        # EXECUTION PARAMETERS
        # ════════════════════════════════════════════════════════════════════

        # Results directory (on local or delegate execution environment)
        base_results_dir: "/tmp/compliance_scans"

        # Enable debug output (verbose logging)
        enable_debug: false

        # Timeout for individual InSpec control execution
        inspec_command_timeout: 1800 # 30 minutes

        # Timeout for async scan execution
        async_scan_timeout: 3600 # 1 hour

        # Poll interval for async status checks
        async_poll_interval: 30 # Check every 30 seconds

    # ────────────────────────────────────────────────────────────────────────
    # GROUP 2: Oracle Database Servers
    # ────────────────────────────────────────────────────────────────────────
    # Oracle 12c, 19c instances

    oracle_databases:
      hosts:
        # Oracle Database 1 (Production)
        oracle_prod_01:
          oracle_server: prod-oracle.internal.com
          oracle_port: 1521
          oracle_database: ORCL
          oracle_service: ORCL
          oracle_version: "19"
          database_platform: oracle

        # Oracle Database 2 (Development)
        oracle_dev_01:
          oracle_server: dev-oracle.internal.com
          oracle_port: 1521
          oracle_database: DEVDB
          oracle_service: DEVDB
          oracle_version: "12"
          database_platform: oracle

      vars:
        # Execution mode (same selection as MSSQL)
        inspec_delegate_host: "inspec-runner" # or "" for local

        # Database credentials
        oracle_username: nist_scan_user
        # oracle_password: injected by AAP Custom Credential

        # Execution parameters
        base_results_dir: "/tmp/compliance_scans"
        enable_debug: false

    # ────────────────────────────────────────────────────────────────────────
    # GROUP 3: Sybase Database Servers (Complex: 3-layer auth)
    # ────────────────────────────────────────────────────────────────────────
    # Sybase ASE 15, 16 instances
    # NOTE: Sybase requires SSH tunnel, so has additional credentials

    sybase_databases:
      hosts:
        # Sybase Database 1 (Production)
        sybase_prod_01:
          sybase_server: prod-sybase.internal.com
          sybase_port: 5000
          sybase_database: master
          sybase_version: "16"
          database_platform: sybase

        # Sybase Database 2 (Development)
        sybase_dev_01:
          sybase_server: dev-sybase.internal.com
          sybase_port: 5000
          sybase_database: master
          sybase_version: "15"
          database_platform: sybase

      vars:
        # Execution mode
        inspec_delegate_host: "inspec-runner" # or "" for local

        # ════════════════════════════════════════════════════════════════════
        # SYBASE: THREE-LAYER AUTHENTICATION
        # ════════════════════════════════════════════════════════════════════
        # Layer 1: Ansible → Delegate (handled by ansible_connection above)
        # Layer 2: InSpec → Sybase via SSH Tunnel
        # Layer 3: isql → Sybase Database

        # LAYER 2: SSH Tunnel Configuration
        # InSpec connects to Sybase via SSH tunnel, not direct TCP
        sybase_use_ssh: true # Enable SSH tunnel
        sybase_ssh_user: sybase_admin # SSH tunnel username
        # sybase_ssh_password: injected by AAP Machine Credential

        # LAYER 3: Database Login
        sybase_username: nist_scan_user # isql username
        # sybase_password: injected by AAP Custom Credential

        # Execution parameters
        base_results_dir: "/tmp/compliance_scans"
        enable_debug: false
# ════════════════════════════════════════════════════════════════════════════════
# SECTION 3: VAULT FILE (for LOCAL TESTING ONLY)
# ════════════════════════════════════════════════════════════════════════════════
#
# For local testing with Ansible directly (not AAP), use vault file
# For AAP execution, credentials come from AAP credentials, NOT vault
#
# File: group_vars/all/vault.yml (or create as needed)
# Encrypt with: ansible-vault encrypt group_vars/all/vault.yml
#
# ╔─────────────────────────────────────────────────────────────────────────╗
# ║ IMPORTANT: Add vault file to .gitignore - DO NOT COMMIT PASSWORDS!     ║
# ╚─────────────────────────────────────────────────────────────────────────╝
#
# Example vault.yml contents:
# ---
# vault_delegate_password: "delegate_host_ssh_password"
# vault_db_password: "database_password_shared_by_all_dbs"
# vault_sybase_ssh_password: "sybase_ssh_tunnel_password"
#

# ════════════════════════════════════════════════════════════════════════════════
# SECTION 4: QUICK START GUIDE
# ════════════════════════════════════════════════════════════════════════════════
#
# TO SWITCH BETWEEN EXECUTION MODES:
# ──────────────────────────────────
#
# Current Mode: DELEGATE (InSpec runs on inspec-runner host)
# To change to LOCAL mode, replace this line:
#   inspec_delegate_host: "inspec-runner"
# with:
#   inspec_delegate_host: ""
#
# ═════════════════════════════════════════════════════════════════════════
#
# TO RUN LOCALLY WITH ANSIBLE (not AAP):
# ────────────────────────────────────────
#
# 1. Create vault file with passwords:
#    ansible-vault create group_vars/all/vault.yml
#    Add: vault_delegate_password: "password"
#         vault_db_password: "password"
#
# 2. Run playbook:
#    ansible-playbook -i inventory.yml \
#                     --ask-vault-pass \
#                     test_playbooks/run_mssql_inspec.yml
#
# 3. When prompted for vault password, enter the password you created
#
# ═════════════════════════════════════════════════════════════════════════
#
# TO RUN IN AAP:
# ──────────────
#
# 1. Create credentials in AAP:
#    - Machine Credential: "Delegate Host SSH Key"
#      (with SSH private key or password)
#    - Custom Credential: "MSSQL Compliance Scan Account"
#      (with username/password for database)
#
# 2. Create Job Template:
#    - Inventory: (select this inventory)
#    - Playbook: test_playbooks/run_mssql_inspec.yml
#    - Credentials: Attach both Machine + Custom credentials
#
# 3. Launch the job
#    AAP automatically injects all credentials
#    No vault file needed in AAP
#
# ═════════════════════════════════════════════════════════════════════════
#
# TROUBLESHOOTING:
# ────────────────
#
# If playbook fails, check:
#
# 1. Execution Mode Detection:
#    - Run: ansible localhost -m debug -a "msg={{ inspec_delegate_host }}"
#    - Should show: "inspec-runner" (delegate) or "" (local)
#
# 2. SSH Connectivity:
#    - Run: ansible inspec-runner -m ping
#    - Should show: "pong" (success)
#    - Or: ssh -v ansible_svc@delegate-host.example.com
#
# 3. Database Connectivity:
#    - On execution host: sqlcmd -S server -U user -P password -Q "SELECT @@VERSION"
#    - Should return version info
#
# 4. Credentials Injected:
#    - Add debug task: debug: msg="{{ mssql_username }}"
#    - Should show: "nist_scan_user"
#    - If not defined: Check credential attachment in AAP
#
# ════════════════════════════════════════════════════════════════════════════════
